<!doctype html><html><head><meta charset=utf-8><meta content="IE=edge,chrome=1" http-equiv=x-ua-compatible><meta content="width=device-width,minimum-scale=1" name=viewport><title>Sergio Carracedo | Database migrations in Golang.</title><meta content="yes" name=apple-mobile-web-app-capable><meta content="black-translucent" name=apple-mobile-web-app-status-bar-style><meta content="Sergio Carracedo's personal page and blog" name=description><meta content="Sergio Carracedo" name=author><link href=/favicon.png rel=icon><meta property="og:title" content="Database migrations in Golang."><meta property="og:description" content="During the development of an app, it&rsquo;s very common to do changes in the database schema, for a new feature you need to add a new table, add a new column to an existing table, alter the type of existing column or delete a column.
When you work alone you could do it manually, run the queries to alter the database schemas manually.
What happens when your team is not a one-person team?"><meta property="og:type" content="article"><meta property="og:url" content="https://sergiocarracedo.es/database-migrations-in-golang/"><meta property="og:image" content="https://sergiocarracedo.es/database-migrations-in-golang/go-migrate-pexels-james-wheeler-1598075_hue3e183c5fa902cd4ae789f3e908b1fee_456451_1920x1080_fill_q75_box_center.jpg"><meta name=twitter:image content="https://sergiocarracedo.es/database-migrations-in-golang/go-migrate-pexels-james-wheeler-1598075_hue3e183c5fa902cd4ae789f3e908b1fee_456451_1920x1080_fill_q75_box_center.jpg"></meta><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-25T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"></meta><link rel=canonical href=https://sergiocarracedo.es/database-migrations-in-golang/><link href=https://sergiocarracedo.es/scss/main.2fd96352cefb0fc6d22a709a5c49be2d08c4854cce0d451385d9b0e30adcce2e.css integrity="sha256-L9ljUs77D8bSKnCaXEm+LQjEhUzODUUThdmw4wrczi4=" rel=stylesheet><link href=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css rel=stylesheet type=text/css></head><body><header class=web-header><h2><a class=back-to-home href=/ title="Back to home"><i class="fas fa-home"></i><div class=back-to-home__content><span class=back-to-home__action>Back to home</span><div class=back-to-home__title><img alt="Sergio Carracedo" class=avatar src=/i/sergiocarracedo_hu6caa808ff324b89bfea4b9d7d1c850ee_80590_100x100_fit_q75_box.jpg><h4>Sergio Carracedo</h4></div></div></a></h2><div class=web-header__page-title><span>Database migrations in Golang.</span></div><div class=theme-switch><i class="theme-switch__theme fas fa-sun" id=theme-switch-light title="Switch to light theme"></i>
<i class="theme-switch__theme fas fa-moon" id=theme-switch-dark title="Switch to dark theme"></i></div></header><div class=main-content><article class="post post--single"><div class="post__main wrapper-1200"><aside class=post__metadata><time class=post__date datetime=2021-10-25><i class="far fa-calendar-alt"></i> Oct 25, 2021</time><div class=post__tags><a href=https://sergiocarracedo.es/tags/devops class=post__tag><span>devops</span></a>
<a href=https://sergiocarracedo.es/tags/golang class=post__tag><span>golang</span></a>
<a href=https://sergiocarracedo.es/tags/database class=post__tag><span>database</span></a></div><span class=post__reading-time><i class="far fa-clock"></i> 5 minutes read</span></aside><header class=post__header><h1 class=post__title>Database migrations in Golang.</h1></header><figure class=post__cover><img src=/database-migrations-in-golang/go-migrate-pexels-james-wheeler-1598075_hue3e183c5fa902cd4ae789f3e908b1fee_456451_1200x400_fill_q75_box_center.jpg alt="Database migrations in Golang." width=1200 height=400></figure><div class=post__content><p>During the development of an app, it&rsquo;s very common to do changes in the database schema, for a new feature you need to add a new table, add a new column to an existing table, alter the type of existing column or delete a column.</p><p>When you work alone you could do it manually, run the queries to alter the database schemas manually.</p><p>What happens when your team is not a one-person team? You need to share the queries to change the schema with your teammates, and they should know what changes they applied before to know if there are some new changes.</p><p>To simplify this task database migration tools were born. These tools do all this thing on behalf us.</p><p>Let see how the workflow with these tools works:</p><ul><li>When a member of the team needs to change something in the schema, she/he creates a text file with the sentences to achieve the new schema.</li><li>This file is usually stored in the repository, for example in a folder called <code>migrations</code>. if we also store it in the repository we can share easily and track changes (New files added, migration files should never be modified)</li><li>When a new migration file is detected the migration tool will run and apply the changes to the database</li></ul><p>Run the migration should be <em>idempotent</em>, that&rsquo;s that you can run it several times with the same migration files, and the final database schema must be the same. To achieve that usually, the migration tools store in a database table the last migration that ran ok and apply the new ones.</p><h1 id=go-migrate>go-migrate</h1><p><a href=https://github.com/golang-migrate/migrate>Go Migrate</a> is a migration tool written in Golang. It can work as a CLI or as a Go library.</p><p>As a CLI tool, you can use it for projects <em>in any language</em>, not necessarily Go.</p><p>Go migrate read the migrations from a source, that they could be: files, GitHub Repo, Bitbucket, AWS S3, Google cloud storage, etc, and applies the changes in the database.</p><p>It supports several database types, but SQL and non-SQL, like <em>PostgreSQL</em>, MySQL, MongoDB, Clickhouse, Cassandra, etc&mldr; <a href=https://github.com/golang-migrate/migrate#databases>See the complete list of supported databases</a>.</p><p>To track which migrations need to be applied, it stores the status in the database.</p><h2 id=installing-go-migrate-cli>Installing go-migrate (CLI)</h2><p>For Go 1.16+ just execute in your terminal</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go install -tags <span style=color:#e6db74>&#39;postgres&#39;</span> github.com/golang-migrate/migrate/v4/cmd/migrate@latest
</span></span></code></pre></div><p>You can also download the binary from <a href=https://github.com/golang-migrate/migrate/releases>here</a></p><p>Check the <a href=https://github.com/golang-migrate/migrate/tree/master/cmd/migrate>documentation</a> for more instructions</p><h2 id=your-first-migration-file>Your first migration file</h2><blockquote><p>In these examples I&rsquo;m going to use Postgres as target database</p></blockquote><p>Our goal is to get the database schema our app needs from the migration files.
The first migration file should create the tables we need.
Imagine we need a &lsquo;user&rsquo; table.</p><p>We must create a file with the following name schema: <code>{version}_{title}.up.{extension}</code>, for example: <code>1_add_users_table.up.sql</code>, with the following content</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>SCHEMA</span> common;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> common.users(
</span></span><span style=display:flex><span>  id SERIAL <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  name VARCHAR <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,  
</span></span><span style=display:flex><span>  email VARCHAR <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  created_at <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> NOW(),  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id);
</span></span></code></pre></div><p>Then we can run migrate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>migrate -source file://migrations -database postgres://user:pass@localhost:5434/database up
</span></span></code></pre></div><p>Go migrate will check the last completed migration version and applies the following, in this case, we never run go migrate so will execute our file.</p><h2 id=adding-more-migration-files>Adding more migration files</h2><p>Imagine that we need to add a new column, for example <code>age</code>. We will create a file with the name <code>2_add_age_to_users.up.sql</code> with content down below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> common.users <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> age INT;  
</span></span></code></pre></div><p>Anyone in the team can run the migrate command again and get the new column.</p><p>if you run again the command, nothing happens because go-migrate knows all migration were applied.</p><p>You can execute go-migrate in a deployment pipeline like GitHub Action to put your database in the correct schema</p><p>One of the advantages of putting the schema updates in migration files, store them in the repo and run go-migrate in the deployment pipeline, is that the database schema can be synced with the app version.
I mean, imagine you are working on a new feature in a new repo branch, you can define the migration files you need for this feature and commit them at the same time your code.
if your code is promoted to the main branch, when the code is deployed, the database update its schema</p><h2 id=migration-rollback>Migration rollback</h2><p>go-migrate also allows us to do a migration rollback, that is a database query or queries to put the database schema as before run the equivalent up file.</p><p>In our example we can write the &lsquo;down&rsquo; file for the second migration <code>2_add_age_to_users.up.sql</code> must have the name <code>2_add_age_to_users.down.sql</code> (the same name replacing <code>up</code> by <code>down</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> common.users <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>COLUMN</span> age;
</span></span></code></pre></div><p>If we want to roll back to version 1 we must run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>migrate -source file://migrations -database postgres://user:pass@localhost:5434/database down <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>Down migration files are usually not written because usually can mean data loss.</p><p><a href=https://twitter.com/taylorotwell?>Taylor Otwell</a> the creator of <a href=https://laravel.com/>Laravel</a> said in an interview:</p><blockquote><p>My view on that recently, in a past year, has been that you just never rollback. Ever. You would always go forward. Because I don’t know how you roll back without losing customer data. At least for my own projects like Forge or Envoyer, I could never really guarantee that I wasn’t losing data, so I think if at all possible, what I would try to do is write an entirely new migration that fixes whatever problem there is, and it would just migrate forward.</p></blockquote><p><a href=https://laraveldaily.com/still-need-migrations-taylor-says-no/>https://laraveldaily.com/still-need-migrations-taylor-says-no/</a></p><h1 id=next-steps>Next steps</h1><p>In this post, I talked about how to use <em>go-migrate</em> as CLI but we can use it in our Golang programs. That it&rsquo;s very useful for example to run an integration test. I will write a post about how to manage integration&rsquo;s test in Go.</p></div></div><aside class=post__nav-wrapper><div class=wrapper-1200><div class="post-nav post-nav--prev"><a class=post-nav__link href="https://sergiocarracedo.es/vue-composition-api-how-to-split-and-reuse-code/?ref=footer"><div class=post-nav__cover><img alt=.NextPage.Title src=/vue-composition-api-how-to-split-and-reuse-code/vue-composition-api-3y1zF4hIPCg-unsplash_hue3e183c5fa902cd4ae789f3e908b1fee_585022_200x120_fill_q75_box_center.jpg></div><div class=post-nav__title>Vue Composition API: How to split and reuse code</div></a></div><div class=blog-link><a class=btn href=https://sergiocarracedo.es/blog>All Blog posts</a></div><div class="post-nav post-nav--next"><a class=post-nav__link href="https://sergiocarracedo.es/creating-custom-events-in-js/?ref=footer"><div class=post-nav__cover><img alt=.PrevPage.Title class=post-nav__cover src=/creating-custom-events-in-js/custom-events-1314544_huf989308e95525c4afa7bed735554eb64_284340_200x120_fill_q75_box_center.jpg></div><div class=post-nav__title>Creating custom events in JS</div></a></div></div></aside><aside class=post__comments><div class=wrapper-1200><div id=disqus_thread>To show the comments is mandatory accept cookie policy.</div></div></aside></article></div><footer class=web-footer><div class=wrapper-1200><div class=web-footer__left><div class=me><div class=me__avatar><img alt="Sergio Carracedo" src=/i/sergiocarracedo_hu6caa808ff324b89bfea4b9d7d1c850ee_80590_170x170_fit_q75_box.jpg></div><div class=me__titles><h1>Sergio Carracedo</h1><h2>Senior Fullstack developer.</h2><h3>Formula 1, cats, good conversations and small details lover.</h3></div></div></div><div class=web-footer__right><nav role=main class=menu><ul><li class=menu__item><a href=https://sergiocarracedo.es/>Home</a></li><li class=menu__item><a href=https://sergiocarracedo.es/blog>Blog</a></li></ul></nav><div class=social><a class=social__link href=http://www.linkedin.com/in/sergiocarracedo target=_blank title=LinkedIn style=animation-delay:2s><i class="fab fa-linkedin"></i></a>
<a class=social__link href=mailto:hi+blog@sergiocarracedo.es target=_blank title=Email style=animation-delay:1.9333333333333333s><i class="fas fa-envelope"></i></a>
<a class=social__link href=https://github.com/sergiocarracedo target=_blank title=GitHub style=animation-delay:1.8666666666666667s><i class="fab fa-github"></i></a>
<a class=social__link href=https://www.drupal.org/u/sergiocarracedo target=_blank title=Drupal style=animation-delay:1.8s><i class="fab fa-drupal"></i></a>
<a class=social__link href=https://www.twitter.com/sergiocarracedo target=_blank title=Twitter style=animation-delay:1.7333333333333334s><i class="fab fa-twitter"></i></a>
<a class=social__link href=http://www.last.fm/user/gasman40 target=_blank title=Last.fm style=animation-delay:1.6666666666666667s><i class="fab fa-lastfm"></i></a>
<a class=social__link href=http://sergiocarracedo.tumblr.com/ target=_blank title=Tumblr style=animation-delay:1.6s><i class="fab fa-tumblr"></i></a></div></div></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=UA-133459072-1"></script>
<script>function runGA(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","UA-133459072-1")}</script><script>function runDisqus(){(function(){var e=document,t=e.createElement("script");t.src="https://sergiocarracedo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()}</script><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js></script>
<script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#004262",text:"#fff"},button:{background:"#8ec760",text:"#ffffff"}},type:"opt-out",content:{message:"Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",allow:"Ok, continua",deny:"Nada de cookies",link:"Saber más",href:"https://sergiocarracedo.es/cookies"},onStatusChange:function(e){e=="allow"&&runCookiesAllowed()},onInitialise:function(e){e=="allow"&&runCookiesAllowed()}})})</script><script>addEventListener("scroll",e=>{let t=document.getElementsByTagName("body")[0];t&&window.scrollY>10?t.classList.add("not-in-top"):t.classList.remove("not-in-top")});function runCookiesAllowed(){runGA(),runDisqus()}</script><script integrity="sha256-6W09eoRhk1Og2XFEl4eaBSED33MOr8P1V5qaL3z+PEY=" src=https://sergiocarracedo.es/js/theme.e96d3d7a84619353a0d9714497879a052103df730eafc3f5579a9a2f7cfe3c46.js></script></body></html>