
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sergio Carracedo - Database migrations in Golang.</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="keywords" content="Sergio Carracedo,"> 
    <meta name="description" content="Sergio Carracedo personal Blog,During the development of an app, it’s very common to do changes in the database schema, for a new ,"> 
    <meta name="author" content="Sergio Carracedo"> 
    <link rel="alternative" href="atom.xml" title="Sergio Carracedo" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="/css/sergiocarracedo.css">

    <meta name="description" content="During the development of an app, it’s very common to do changes in the database schema, for a new feature you need to add a new table, add a new column to an existing table, alter the type of existin">
<meta property="og:type" content="article">
<meta property="og:title" content="Database migrations in Golang.">
<meta property="og:url" content="https://sergiocarracedo.es/database-migrations-in-golang/index.html">
<meta property="og:site_name" content="Sergio Carracedo">
<meta property="og:description" content="During the development of an app, it’s very common to do changes in the database schema, for a new feature you need to add a new table, add a new column to an existing table, alter the type of existin">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sergiocarracedo.es/images/2021/go-migrate-pexels-james-wheeler-1598075.jpg">
<meta property="article:published_time" content="2021-10-25T00:00:00.000Z">
<meta property="article:modified_time" content="2022-02-27T17:09:31.287Z">
<meta property="article:author" content="Sergio Carracedo">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sergiocarracedo.es/images/2021/go-migrate-pexels-james-wheeler-1598075.jpg">

    <script async src='https://www.google-analytics.com/analytics.js'></script>

    <script>
      function runGA() {
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', 'UA-133459072-1', 'auto');
        ga('send', 'pageview');
      }

      function runDisqus() {
        /*var disqus_config = function () {
          this.page.url = 'https://sergiocarracedo.es/';
          this.page.identifier = 'sergiocarracedo';
        }*/
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://sergiocarracedo.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      }

      function runCookiesAllowed() {
        runGA();
        runDisqus();
      }
    </script>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
    <div id="single">
    <div id="top">
  <div class="bar" style="width: 0;"></div>
  <div class="container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 col-sm-3">
        <a class="back-to-home" href="/">
          <img src="/img/sergiocarracedo.jpg" alt="Sergio Carracedo" class="image-logo"/>
          <h4>
            Sergio Carracedo
          </h4>
        </a>
      </div>
      <div class="hidden-xs hidden-lxs col-sm-6">
        <h3 class="subtitle">Database migrations in Golang.</h3>
      </div>
    </div>
  </div>
  <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article container-fluid-1200">
  <div class="grid-row">
    <div class="main col-xs-12">
      <h1 class="title">
        Database migrations in Golang.
      </h1>
      <div class="stuff">
        <span>October 25, 2021</span>
      </div>

      
      <div class="article-image">
        <img src="/images/2021/header_go-migrate-pexels-james-wheeler-1598075.jpg" width="1200" height="400">
      </div>
      
      <div class="content markdown">
        <p>During the development of an app, it’s very common to do changes in the database schema, for a new feature you need to add a new table, add a new column to an existing table, alter the type of existing column or delete a column.</p>
<p>When you work alone you could do it manually, run the queries to alter the database schemas manually.</p>
<p>What happens when your team is not a one-person team? You need to share the queries to change the schema with your teammates, and they should know what changes they applied before to know if there are some new changes.</p>
<p>To simplify this task database migration tools were born. These tools do all this thing on behalf us.</p>
<p>Let see how the workflow with these tools works: </p>
<ul>
<li>When a member of the team needs to change something in the schema, she/he creates a text file with the sentences to achieve the new schema.</li>
<li>This file is usually stored in the repository, for example in a folder called <code>migrations</code>. if we also store it in the repository we can share easily and track changes (New files added, migration files should never be modified)</li>
<li>When a new migration file is detected the migration tool will run and apply the changes to the database</li>
</ul>
<p>Run the migration should be <em>idempotent</em>, that’s that you can run it several times with the same migration files, and the final database schema must be the same. To achieve that usually, the migration tools store in a database table the last migration that ran ok and apply the new ones.</p>
<h1 id="go-migrate"><a href="#go-migrate" class="headerlink" title="go-migrate"></a>go-migrate</h1><p><a target="_blank" rel="noopener" href="https://github.com/golang-migrate/migrate">Go Migrate</a> is a migration tool written in Golang. It can work as a CLI or as a Go library.</p>
<p>As a CLI tool, you can use it for projects <em>in any language</em>, not necessarily Go.</p>
<p>Go migrate read the migrations from a source, that they could be: files, GitHub Repo, Bitbucket, AWS S3, Google cloud storage, etc, and applies the changes in the database.</p>
<p>It supports several database types, but SQL and non-SQL, like <em>PostgreSQL</em>, MySQL, MongoDB, Clickhouse, Cassandra, etc… <a target="_blank" rel="noopener" href="https://github.com/golang-migrate/migrate#databases">See the complete list of supported databases</a>.  </p>
<p>To track which migrations need to be applied, it stores the status in the database.  </p>
<h2 id="Installing-go-migrate-CLI"><a href="#Installing-go-migrate-CLI" class="headerlink" title="Installing go-migrate (CLI)"></a>Installing go-migrate (CLI)</h2><p>For Go 1.16+ just execute in your terminal</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install -tags <span class="string">'postgres'</span> github.com/golang-migrate/migrate/v4/cmd/migrate@latest</span><br></pre></td></tr></tbody></table></figure>

<p>You can also download the binary from <a target="_blank" rel="noopener" href="https://github.com/golang-migrate/migrate/releases">here</a></p>
<p>Check the <a target="_blank" rel="noopener" href="https://github.com/golang-migrate/migrate/tree/master/cmd/migrate">documentation</a> for more instructions</p>
<h2 id="Your-first-migration-file"><a href="#Your-first-migration-file" class="headerlink" title="Your first migration file"></a>Your first migration file</h2><blockquote>
<p>In these examples I’m going to use Postgres as target database</p>
</blockquote>
<p>Our goal is to get the database schema our app needs from the migration files.<br>The first migration file should create the tables we need.<br>Imagine we need a ‘user’ table.</p>
<p>We must create a file with the following name schema: <code>{version}_{title}.up.{extension}</code>, for example: <code>1_add_users_table.up.sql</code>, with the following content</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SCHEMA common;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> common.users(</span><br><span class="line">  id SERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  name <span class="type">VARCHAR</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  </span><br><span class="line">  email <span class="type">VARCHAR</span> <span class="keyword">UNIQUE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> NOW(),  </span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (id);</span><br></pre></td></tr></tbody></table></figure>

<p>Then we can run migrate:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate -<span class="built_in">source</span> file://migrations -database postgres://user:pass@localhost:5434/database up</span><br></pre></td></tr></tbody></table></figure>

<p>Go migrate will check the last completed migration version and applies the following, in this case, we never run go migrate so will execute our file.</p>
<h2 id="Adding-more-migration-files"><a href="#Adding-more-migration-files" class="headerlink" title="Adding more migration files"></a>Adding more migration files</h2><p>Imagine that we need to add a new column, for example <code>age</code>. We will create a file with the name <code>2_add_age_to_users.up.sql</code> with content down below:</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> common.users <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> age <span class="type">INT</span>;  </span><br></pre></td></tr></tbody></table></figure>

<p>Anyone in the team can run the migrate command again and get the new column.</p>
<p>if you run again the command, nothing happens because go-migrate knows all migration were applied.</p>
<p>You can execute go-migrate in a deployment pipeline like GitHub Action to put your database in the correct schema</p>
<p>One of the advantages of putting the schema updates in migration files, store them in the repo and run go-migrate in the deployment pipeline, is that the database schema can be synced with the app version.<br>I mean, imagine you are working on a new feature in a new repo branch, you can define the migration files you need for this feature and commit them at the same time your code.<br>if your code is promoted to the main branch, when the code is deployed, the database update its schema </p>
<h2 id="Migration-rollback"><a href="#Migration-rollback" class="headerlink" title="Migration rollback"></a>Migration rollback</h2><p>go-migrate also allows us to do a migration rollback, that is a database query or queries to put the database schema as before run the equivalent up file.</p>
<p>In our example we can write the ‘down’ file for the second migration <code>2_add_age_to_users.up.sql</code> must have the name <code>2_add_age_to_users.down.sql</code> (the same name replacing <code>up</code> by <code>down</code>)</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> common.users <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> age;</span><br></pre></td></tr></tbody></table></figure>
<p>If we want to roll back to version 1 we must run:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate -<span class="built_in">source</span> file://migrations -database postgres://user:pass@localhost:5434/database down 2</span><br></pre></td></tr></tbody></table></figure>

<p>Down migration files are usually not written because usually can mean data loss.</p>
<p><a target="_blank" rel="noopener" href="https://twitter.com/taylorotwell">Taylor Otwell</a> the creator of <a target="_blank" rel="noopener" href="https://laravel.com/">Laravel</a> said in an interview:</p>
<blockquote>
<p>My view on that recently, in a past year, has been that you just never rollback. Ever. You would always go forward. Because I don’t know how you roll back without losing customer data. At least for my own projects like Forge or Envoyer, I could never really guarantee that I wasn’t losing data, so I think if at all possible, what I would try to do is write an entirely new migration that fixes whatever problem there is, and it would just migrate forward.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://laraveldaily.com/still-need-migrations-taylor-says-no/">https://laraveldaily.com/still-need-migrations-taylor-says-no/</a></p>
<h1 id="Next-steps"><a href="#Next-steps" class="headerlink" title="Next steps"></a>Next steps</h1><p>In this post, I talked about how to use <em>go-migrate</em> as CLI but we can use it in our Golang programs. That it’s very useful for example to run an integration test. I will write a post about how to manage integration’s test in Go.</p>

      </div>
    </div>
  </div>
</div>

<div class="post-nav">
  <div class="container-fluid-1200">
    <div class="grid-row">
      <div class="next col-xs-6">
        
          <div class="nav-previous">
            <a href="https://sergiocarracedo.es//vue-composition-api-how-to-split-and-reuse-code/" rel="prev" class="nav-cover">
              <img src="/images/2021/teaser_vue-composition-api-3y1zF4hIPCg-unsplash.jpg">
            </a>

            <a href="https://sergiocarracedo.es//vue-composition-api-how-to-split-and-reuse-code/" rel="prev" class="nav-text">
              <i class="fa fa-arrow-left"></i> Vue Composition API: How to split and reuse code
            </a>
          </div>
        
      </div>
      <div class="prev col-xs-6">
        
          <div class="nav-next">
            <a href="https://sergiocarracedo.es//creating-custom-events-in-js/" rel="next" class="nav-cover">
              <img src="/images/2021/teaser_custom-events-1314544.jpg">
            </a>

            <a href="https://sergiocarracedo.es//creating-custom-events-in-js/" rel="next" class="nav-text">
              Creating custom events in JS <i class="fa fa-arrow-right"></i>
            </a>
          </div>
        
      </div>
    </div>
  </div>
</div>

<div class="post-comments container-fluid-1200">
    <div id="disqus_thread">To show the comments is mandatory accept cookie policy.</div>
</div>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<div id="post-aboutme">
  <div class="me container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 mb-5">
        <div class="social">
  <a href="http://www.linkedin.com/in/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-linkedin"></i>
  </a>
  <a href="mailto:hi+blog@sergiocarracedo.es" class="social-link" title="hi+blog@sergiocarracedo.es">
    <i class="fas fa-envelope"></i>
  </a>

  <a href="https://github.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-github"></i>
  </a>
  <a href="https://www.drupal.org/u/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-drupal"></i>
  </a>


  <a href="https://www.twitter.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="http://www.last.fm/user/gasman40" class="social-link" target="_blank">
    <i class="fab fa-lastfm"></i>
  </a>
  <a href="http://sergiocarracedo.tumblr.com/" class="social-link" target="_blank">
    <i class="fab fa-tumblr"></i>
  </a>
</div>

      </div>
    </div>
  </div>

  <div class="claim container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <h3>Front-end and back-end developer.<br />#formula1, good conversations and small details lover.</h3>
      </div>
    </div>
  </div>

  <div class="container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <a href="/" class="back">
          Home
        </a>
      </div>
    </div>
  </div>

</div>


    </div>


</div>

</body>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<script src="/js/jquery.min.js"></script>
<script src="/js/sergiocarracedo.js"></script>


<link href="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css" rel="stylesheet">

<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
    <script>
      window.addEventListener("load", function(){
        window.cookieconsent.initialise({
          "palette": {
            "popup": {
              "background": "#004262",
              "text": "#fff"
            },
            "button": {
              "background": "#8ec760",
              "text": "#ffffff"
            }
          },
          "type": "opt-out",
          "content": {
            "message": "Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",
            "allow": "Ok, continua",
            "deny": "Nada de cookies",
            "link": "Saber más",
            "href": "https://sergiocarracedo.es/cookies.html",
          },
          "onStatusChange": function(status, chosenBefore) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          },
          "onInitialise" : function(status) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          }
        })
      });
    </script>


</html>
