
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sergio Carracedo - Webkit (Safari) memory leak using SVG filters</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="keywords" content="Sergio Carracedo,"> 
    <meta name="description" content="Sergio Carracedo personal Blog,The contextA few weeks ago I was developing a website using NuxtJs (which is not important for the ,"> 
    <meta name="author" content="Sergio Carracedo"> 
    <link rel="alternative" href="atom.xml" title="Sergio Carracedo" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="/css/sergiocarracedo.css">

    <meta name="description" content="The contextA few weeks ago I was developing a website using NuxtJs (which is not important for the problem but the is the context 😉 ). That was a website that needs to use a few images as building bl">
<meta property="og:type" content="article">
<meta property="og:title" content="Webkit (Safari) memory leak using SVG filters">
<meta property="og:url" content="https://sergiocarracedo.es/2020/safari-svg-filters-memory-leak/index.html">
<meta property="og:site_name" content="Sergio Carracedo">
<meta property="og:description" content="The contextA few weeks ago I was developing a website using NuxtJs (which is not important for the problem but the is the context 😉 ). That was a website that needs to use a few images as building bl">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sergiocarracedo.es/images/2020/safari-svg/cover_pixbay_1807581.jpg">
<meta property="article:published_time" content="2020-11-02T00:00:00.000Z">
<meta property="article:modified_time" content="2021-06-14T11:22:16.960Z">
<meta property="article:author" content="Sergio Carracedo">
<meta property="article:tag" content="safari">
<meta property="article:tag" content="bug">
<meta property="article:tag" content="browserstack">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sergiocarracedo.es/images/2020/safari-svg/cover_pixbay_1807581.jpg">

    <script async src='https://www.google-analytics.com/analytics.js'></script>

    <script>
      function runGA() {
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', 'UA-133459072-1', 'auto');
        ga('send', 'pageview');
      }

      function runDisqus() {
        /*var disqus_config = function () {
          this.page.url = 'https://sergiocarracedo.es/';
          this.page.identifier = 'sergiocarracedo';
        }*/
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://sergiocarracedo.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      }

      function runCookiesAllowed() {
        runGA();
        runDisqus();
      }
    </script>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="single">
    <div id="top">
  <div class="bar" style="width: 0;"></div>
  <div class="container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 col-sm-3">
        <a class="back-to-home" href="/">
          <img src="/img/sergiocarracedo.jpg" alt="Sergio Carracedo" class="image-logo"/>
          <h4>
            Sergio Carracedo
          </h4>
        </a>
      </div>
      <div class="hidden-xs col-sm-6">
        <h3 class="subtitle">Webkit (Safari) memory leak using SVG filters</h3>
      </div>
    </div>
  </div>
  <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article container-fluid-1200">
  <div class="grid-row">
    <div class="main col-xs-12">
      <h1 class="title">
        Webkit (Safari) memory leak using SVG filters
      </h1>
      <div class="stuff">
        <span>November 02, 2020</span>
      </div>

      
      <div class="article-image">
        <img src="/images/2020/safari-svg/header_cover_pixbay_1807581.jpg" width="1200" height="400">
      </div>
      
      <div class="content markdown">
        <h2 id="The-context"><a href="#The-context" class="headerlink" title="The context"></a>The context</h2><p>A few weeks ago I was developing a website using <a target="_blank" rel="noopener" href="https://nuxtjs.org/">NuxtJs</a> (which is not important for the problem but the is the context <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f609.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f609.png?v8">😉</span> ). That was a website that needs to use a few images as building blocks, the typical section separator with a shape different to a simple line, in this case, the section’s separator had 2 colors and a shadow.</p>
<p>I decided to use SVG images for several reasons, for example the images had to adapt to different screen widths, and the images were simple (more complex than a line but simple, They were similar to 2 waves with 2 colors). The SVG files are very useful in these use case, because the file size is small, and you can scale them infinitely without lost definition.<br>One important thing in this issue as we’ll see later is that this image had a shadow.</p>
<h2 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h2><p>Well, I was almost done templating the website, and we started to test the website in different browsers and platforms, and everything was fine, except because Safari users complain about the browser displays a notice:</p>
<blockquote>
<p>This webpage is using significant memory. Closing it may improve the responsiveness of your Mac.</p>
</blockquote>
<p>As side effect, the website animations were not fluid.</p>
<h2 id="Reproducing-the-problem-and-fixing-it"><a href="#Reproducing-the-problem-and-fixing-it" class="headerlink" title="Reproducing the problem and fixing it"></a>Reproducing the problem and fixing it</h2><p>I needed to test the website by myself to find the reason of this issue. I don’t own a Mac computer, but I have a <a target="_blank" rel="noopener" href="https://www.browserstack.com/">BrowserStack</a> account.</p>
<p><a target="_blank" rel="noopener" href="https://www.browserstack.com/">BrowserStack</a> is a SaaS that allows you to connect, using your browser, to remote devices with other browsers / OS. You can even select old browser versions, a mobile device (like iPhones, etc)</p>
<p><img src="/images/2020/safari-svg/browserstack.jpg" alt=""> </p>
<blockquote>
<p><strong>Off-Topic</strong>: BrowserStack supports my open source project <a target="_blank" rel="noopener" href="https://sirenogrid.com/">SirenoGrid</a></p>
</blockquote>
<p>So, with my BrowserStack account, I could try to reproduce the problem. I open a Safari 13.1 (lastest version) instance in MacOS Catalina, and opened the website, and using the devtools got info about memory usage, and <strong>it was over 1.4 GB!!!!</strong><br>And if you reloaded the website memory usage grows until the system got unresponsive.</p>
<p>The first thing I thought is that the problem was the animations. I remove them: <em>Nothing changes</em>.</p>
<p>I remove javascript: <em>Nothing</em> <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f615.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f615.png?v8">😕</span></p>
<p>I continue removing things and trying other things to understand the problem. <em>No results</em> <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png?v8">😮</span></p>
<p>After a long time, I was already a little desperate I disabled all website content blocks, and I realized that when it was a block with an SVG image in the screen, the memory usage was high.</p>
<p>I tried the same for a block with a png image and memory still normal.</p>
<p>WTF?? It should be SVG images.</p>
<p>Then, I replaced all SVG images with PNG versions and website works with reasonable memory usage <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8">🎉</span></p>
<h2 id="Isolating-the-issue"><a href="#Isolating-the-issue" class="headerlink" title="Isolating the issue"></a>Isolating the issue</h2><p>After fixing the problem and with more time I wanted to know because SVG files were causing this high memory usage.</p>
<p>I searched on Google information for issues in Safari and SVG and I didn’t find anything that fit my issue, some diffuse references.</p>
<p>I created a sandbox to isolate the issue, I will not go into detail, but after some test and fail iterations I realized that the issue was related to SVG Filters.</p>
<p>With this information, I repeated the Google search, and I found information relative to Safari, SVG and filters issues <a target="_blank" rel="noopener" href="https://bugs.webkit.org/show_bug.cgi?id=78814">1</a>, <a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=583471">2</a> (Some of them are very old), and the most similar: <a target="_blank" rel="noopener" href="https://github.com/mapbox/mapbox-gl-js/issues/7476">https://github.com/mapbox/mapbox-gl-js/issues/7476</a></p>
<h2 id="The-bug"><a href="#The-bug" class="headerlink" title="The bug"></a>The bug</h2><p>If you open in Safari a normal webpage, for example: <a target="_blank" rel="noopener" href="https://apple.com">https://apple.com</a> which is a webpage with images, javascript, animations, video, etc. The Safari Timeline inspector says the memory usage is around 205MB</p>
<img src="/images/2020/safari-svg/apple_com.jpg" class="center mb-3">

<p>I prepared a bug demo codesandbox, just with 2 simple svg images: </p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://5emtw.csb.app">https://5emtw.csb.app</a> <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8">❗</span> Open with responsibility in Safari <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8">❗</span></p>
</blockquote>
<p>And in the first load that is the memory usage is around 600 MB!!!! :exploding_head: That’s crazy</p>
<img src="/images/2020/safari-svg/memory_leak.jpg" class="center mb-3">

<p>And if you reload the page a few times the situations will be worse</p>
<img src="/images/2020/safari-svg/memory_leak_after_3_reloads.jpg" class="center mb-3">

<p>After 3 reloads the memory usage is 1.26 GB, absolutely crazy.</p>
<p>The same page, and the same images, but without filters</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://5emtw.csb.app/nofilters.html">https://5emtw.csb.app/nofilters.html</a></p>
</blockquote>
<p>The memory usage is only 21 MB, that it’s a very normal memory usage</p>
<img src="/images/2020/safari-svg/without-filters.jpg" class="center mb-3">


<p>Even with a simple filter, like:</p>
<p><code>&lt;feFlood flood-opacity="1" result="BackgroundImageFix"/&gt;</code></p>
<p>The memory starts to go high, I’m not sure what cause the problem, but in my opinion is something related to composition, I guess the browser keeps in memory the raw result of applying a filter and after making all the compositions layers      .</p>
<p>I reported that bug in the Webkit Bugzilla page: <a target="_blank" rel="noopener" href="https://bugs.webkit.org/show_bug.cgi?id=218422">https://bugs.webkit.org/show_bug.cgi?id=218422</a><br>I hope they fix it soon.</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      </div>
    </div>
  </div>
</div>

<div class="post-nav">
  <div class="container-fluid-1200">
    <div class="grid-row">
      <div class="next col-xs-6">
        
          <div class="nav-previous">
            <a href="https://sergiocarracedo.es/2020/2020-in-a-nutshell/" rel="prev" class="nav-cover">
              <img src="/images/2020/nutshell/teaser_pexels-cottonbro-3401900.jpg">
            </a>

            <a href="https://sergiocarracedo.es/2020/2020-in-a-nutshell/" rel="prev" class="nav-text">
              <i class="fa fa-arrow-left"></i> 2020 in a nutshell
            </a>
          </div>
        
      </div>
      <div class="prev col-xs-6">
        
          <div class="nav-next">
            <a href="https://sergiocarracedo.es/2020/creating-your-own-vue-ui-components-library-from-scratch-to-npm/" rel="next" class="nav-cover">
              <img src="/images/teaser_vue-components-talk.jpg">
            </a>

            <a href="https://sergiocarracedo.es/2020/creating-your-own-vue-ui-components-library-from-scratch-to-npm/" rel="next" class="nav-text">
              Talk: Creating your own Vue UI components library: From scratch to NPM <i class="fa fa-arrow-right"></i>
            </a>
          </div>
        
      </div>
    </div>
  </div>
</div>

<div class="post-comments container-fluid-1200">
    <div id="disqus_thread">To show the comments is mandatory accept cookie policy.</div>
</div>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<div id="post-aboutme">
  <div class="me container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 mb-5">
        <div class="social">
  <a href="mailto:info@sergiocarracedo.es" class="social-link" title="info@sergiocarracedo.es">
    <i class="fas fa-envelope"></i>
  </a>
  <a href="https://github.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-github"></i>
  </a>
  <a href="https://www.drupal.org/u/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-drupal"></i>
  </a>

  <a href="http://www.linkedin.com/in/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-linkedin"></i>
  </a>
  <a href="https://www.twitter.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="http://www.last.fm/user/gasman40" class="social-link" target="_blank">
    <i class="fab fa-lastfm"></i>
  </a>
  <a href="http://sergiocarracedo.tumblr.com/" class="social-link" target="_blank">
    <i class="fab fa-tumblr"></i>
  </a>
</div>

      </div>
    </div>
  </div>

  <div class="claim container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <h3>Front-end and back-end developer.<br />#formula1, good conversations and small details lover.</h3>
      </div>
    </div>
  </div>

  <div class="container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <a href="/" class="back">
          Home
        </a>
      </div>
    </div>
  </div>

</div>


    </div>


</div>

</body>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<script src="/js/jquery.min.js"></script>
<script src="/js/sergiocarracedo.js"></script>


<link href="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css" rel="stylesheet">

<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
    <script>
      window.addEventListener("load", function(){
        window.cookieconsent.initialise({
          "palette": {
            "popup": {
              "background": "#004262",
              "text": "#fff"
            },
            "button": {
              "background": "#8ec760",
              "text": "#ffffff"
            }
          },
          "type": "opt-out",
          "content": {
            "message": "Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",
            "allow": "Ok, continua",
            "deny": "Nada de cookies",
            "link": "Saber más",
            "href": "https://sergiocarracedo.es/cookies.html",
          },
          "onStatusChange": function(status, chosenBefore) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          },
          "onInitialise" : function(status) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          }
        })
      });
    </script>


</html>
