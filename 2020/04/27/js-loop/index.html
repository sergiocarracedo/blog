
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sergio Carracedo - Understanding Javascript's event loop: Macrotasks and microtasks</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="keywords" content="Sergio Carracedo,"> 
    <meta name="description" content="Sergio Carracedo personal Blog,Despite what it may seem, Javascript execution in a browser is synchronous. It is a similar thing a,"> 
    <meta name="author" content="Sergio Carracedo"> 
    <link rel="alternative" href="atom.xml" title="Sergio Carracedo" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="/css/sergiocarracedo.css">

    <meta name="description" content="Despite what it may seem, Javascript execution in a browser is synchronous. It is a similar thing as a multitask OS running in a mono-core processor, in that case multitasking is “fake”, because the p">
<meta property="og:type" content="article">
<meta property="og:title" content="Understanding Javascript&#39;s event loop: Macrotasks and microtasks">
<meta property="og:url" content="https://sergiocarracedo.es/2020/04/27/js-loop/index.html">
<meta property="og:site_name" content="Sergio Carracedo">
<meta property="og:description" content="Despite what it may seem, Javascript execution in a browser is synchronous. It is a similar thing as a multitask OS running in a mono-core processor, in that case multitasking is “fake”, because the p">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sergiocarracedo.es/images/js-event-loop-106155.jpg">
<meta property="article:published_time" content="2020-04-27T00:00:00.000Z">
<meta property="article:modified_time" content="2021-04-19T06:29:57.801Z">
<meta property="article:author" content="Sergio Carracedo">
<meta property="article:tag" content="js loop">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sergiocarracedo.es/images/js-event-loop-106155.jpg">

    <script async src='https://www.google-analytics.com/analytics.js'></script>

    <script>
      function runGA() {
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', 'UA-133459072-1', 'auto');
        ga('send', 'pageview');
      }

      function runDisqus() {
        /*var disqus_config = function () {
          this.page.url = 'https://sergiocarracedo.es/';
          this.page.identifier = 'sergiocarracedo';
        }*/
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://sergiocarracedo.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      }

      function runCookiesAllowed() {
        runGA();
        runDisqus();
      }
    </script>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="single">
    <div id="top">
  <div class="bar" style="width: 0;"></div>
  <div class="container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 col-sm-3">
        <a class="back-to-home" href="/">
          <img src="/img/sergiocarracedo.jpg" alt="Sergio Carracedo" class="image-logo"/>
          <h4>
            Sergio Carracedo
          </h4>
        </a>
      </div>
      <div class="hidden-xs col-sm-6">
        <h3 class="subtitle">Understanding Javascript's event loop: Macrotasks and microtasks</h3>
      </div>
    </div>
  </div>
  <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article container-fluid-1200">
  <div class="grid-row">
    <div class="main col-xs-12">
      <h1 class="title">
        Understanding Javascript's event loop: Macrotasks and microtasks
      </h1>
      <div class="stuff">
        <span>April 27, 2020</span>
      </div>

      
      <div class="article-image">
        <img src="/images/header_js-event-loop-106155.jpg" width="1200" height="400">
      </div>
      
      <div class="content markdown">
        <p>Despite what it may seem, Javascript execution in a browser is <em>synchronous</em>. It is a similar thing as a <em>multitask</em> OS running in a mono-core processor, in that case multitasking is “fake”, because the processor can only execute one instruction at a time, but the OS controls the execution and distribute the processor time between each app, making it looks like multitasking.</p>
<p>In <em>Javascript</em> we have a similar approximation in a way to distribute the execution time. It’s not exactly the same. Lets see how it works.</p>
<h1 id="Event-loop"><a href="#Event-loop" class="headerlink" title="Event loop"></a>Event loop</h1><p>When you write a program in JS, every script you add or every instruction will be added to a queue in the <em>event loop</em></p>
<p>The engine starts to run every instruction in the same order you wrote, running all tasks, and when finish, it waits for more tasks and then starts again.</p>
<p>Every task in this queue is a <strong>macrotask</strong> and queue is the <strong>macrotask queue</strong>. Some examples of macrotasks are:</p>
<ul>
<li>Every <code>&lt;script&gt;</code> loaded and all the instructions on them</li>
<li><code>setInterval</code> or <code>setTimeout</code> command</li>
<li>DOM event: <code>window.load</code>, <code>mouseout</code>, etc </li>
</ul>
<p>In example below, we run some task: calculate the 6th element on Fibonacci series and get a string with the English alphabet. I put some <code>console.log</code> as code execution checkpoint to show the execution order.</p>
<iframe src="https://codesandbox.io/s/romantic-lewin-i1fjz?fontsize=14&amp;hidenavigation=1&amp;previewwindow=console&amp;runonclick=1&amp;initialpath=macrotasks.html&amp;module=/src/macrotasks.js&amp;theme=dark" width="100%" height="500px" frameborder="0" loading="lazy" allowfullscreen=""></iframe>

<p>The result is</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Checkpoint 1 </span><br><span class="line">13</span><br><span class="line">Checkpoint 2: 0.5600000149570405ms </span><br><span class="line">ABCDEFGHIJKLMNOPQRSTUVWXYZ </span><br><span class="line">Checkpoint 3 </span><br></pre></td></tr></tbody></table></figure>

<p>As you can see, the tasks run in order, string generation doesn’t start until fibonacci function finish, even if the function takes long time to be completed.</p>
<p>Let’s see what happens when you use <code>setTimeout</code>. When you set a timeout, you expect your function will be executed after the timeout you set. For example <code>setTimeout(() =&gt; console.log('here'), 1000)</code> should print in console ‘here’ after <strong>1s</strong>. You expect this always happens, no cares about next task or instructions. If you expect that, you are wrong. Check next code:</p>
<iframe src="https://codesandbox.io/s/romantic-lewin-i1fjz?fontsize=14&amp;hidenavigation=1&amp;previewwindow=console&amp;runonclick=1&amp;initialpath=macrotasksSetTimeout.html&amp;module=/src/macrotasksSetTimeout.js&amp;theme=dark" width="100%" height="500px" frameborder="0" loading="lazy" allowfullscreen=""></iframe>

<p>We have a long task after the timeout. Timeout should be executed after <strong>1s</strong>, but next task takes <strong>5s</strong> to be completed, and your timeout not executed yet. Ok let’s wait long task end, and… nothing, your timeout still missing. Next macrotask is our string generator, this task is executed and, finally, after all macrotask, our timeout is executed.</p>
<p>That occurs because, when you use a timeout, you are moving the task at the end of the queue, an at this point is when js engine checks if your timeout should be executed.</p>
<h2 id="Taking-advantage"><a href="#Taking-advantage" class="headerlink" title="Taking advantage"></a>Taking advantage</h2><p>You can take advantage of that event loop behavior, for example, you can put a high CPU usage task inside a <code>setTimeout</code>, even with 0ms of dispatch time, and this huge task will be executed after following tasks.<br>That is a fast solution, but if you have more than 1 or 2 long tasks, you are only moving the problem to the end of the queue, but problem is still there.</p>
<h2 id="Using-Promises"><a href="#Using-Promises" class="headerlink" title="Using Promises"></a>Using Promises</h2><p>You could think of using promises, for example</p>
<iframe src="https://codesandbox.io/s/romantic-lewin-i1fjz?fontsize=14&amp;hidenavigation=1&amp;previewwindow=console&amp;runonclick=1&amp;initialpath=macrotasksPromise.html&amp;module=/src/macrotasksPromise.js&amp;theme=dark" width="100%" height="500px" frameborder="0" loading="lazy" allowfullscreen=""></iframe>

<p>But the promise starts to run the code inside just after call the promise’s constructor, and your program is stucked again. You can resolve it using <code>setTimeout</code> again, but in this case we are creating a <strong>microtask</strong>:</p>
<h2 id="Microtasks"><a href="#Microtasks" class="headerlink" title="Microtasks"></a>Microtasks</h2><p>Microtasks are tasks created in promises (then, catch, finally). The microtask queue run immediately after every macrotask, before render or before the next macrotask</p>
<iframe src="https://codesandbox.io/s/romantic-lewin-i1fjz?fontsize=14&amp;hidenavigation=1&amp;previewwindow=console&amp;runonclick=1&amp;initialpath=microtasksPromise.html&amp;module=/src/microtasksPromise.js&amp;theme=dark" width="100%" height="500px" frameborder="0" loading="lazy" allowfullscreen=""></iframe>

<p>In that example, <code>setTimeout</code> creates a new macrotask, so it will run after macrotask loop, Promise creates a microtask that will be executed after next macrotrask ends, in this case after all script instructions but before the queued macrostask. And finally will run the <code>setTimeout</code> macrotask</p>
<p>There are another way to create a microtask, using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask"><code>queueMicrotask</code></a> that is a recent addition to the standard. it’s supported by most modern browsers (<a target="_blank" rel="noopener" href="https://caniuse.com/#search=queueMicrotask">https://caniuse.com/#search=queueMicrotask</a>) but if not, you can use this polyfill:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span>.queueMicrotask !== <span class="string">'function'</span>) {</span><br><span class="line">  <span class="built_in">window</span>.queueMicrotask = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>{</span><br><span class="line">    <span class="built_in">Promise</span>.resolve()</span><br><span class="line">      .then(callback)</span><br><span class="line">      .catch(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> { <span class="keyword">throw</span> e }))</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>And works exactly as the previous example but syntax is clearer</p>
<iframe src="https://codesandbox.io/s/romantic-lewin-i1fjz?fontsize=14&amp;hidenavigation=1&amp;previewwindow=console&amp;runonclick=1&amp;initialpath=microtasksPromise.html&amp;module=/src/microtasksPromise.js&amp;theme=dark" width="100%" height="500px" frameborder="0" loading="lazy" allowfullscreen=""></iframe>

<h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><p>If you are using Vue, maybe you can show a loader or some kind of indicator when you go to execute a long task.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  data: {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      loading: <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    ...</span><br><span class="line">    longTask () {</span><br><span class="line">      <span class="built_in">this</span>.loading = <span class="literal">true</span></span><br><span class="line">      <span class="comment">// doing your long task stuff</span></span><br><span class="line">      <span class="built_in">this</span>.loading = <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>You could think that the loader will be showed before start the long task and hidden after it, but that not happens, you never see the loader, because the reactive properties are “checked” after the loop and at this point <code>this.loading</code> is <code>false</code>.</p>
<p>You can try to use <code>$.nextTick</code> but the result it’s the same, you need to get out of the event loop with your long task</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  data: {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      loading: <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    ...</span><br><span class="line">    longTask () {</span><br><span class="line">      <span class="built_in">this</span>.loading = <span class="literal">true</span></span><br><span class="line">      queueMicrotask(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// doing your long task stuff)</span></span><br><span class="line">        <span class="built_in">this</span>.loading = <span class="literal">false</span>      </span><br><span class="line">      }      </span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>Above I wrote that Javascript is <em>synchronous</em>, but I lied <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8">😅</span>. You can use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">WebWorkers</a>, this is topic for another post… :simple_smile:</p>
<p>More info: <a target="_blank" rel="noopener" href="https://javascript.info/event-loop">https://javascript.info/event-loop</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      </div>
    </div>
  </div>
</div>

<div class="post-nav">
  <div class="container-fluid-1200">
    <div class="grid-row">
      <div class="next col-xs-6">
        
          <div class="nav-previous">
            <a href="https://sergiocarracedo.es//2020/05/09/js-unary-operators-and-taking-advantage/" rel="prev" class="nav-cover">
              <img src="/images/teaser_unary-operators-1364700.jpg">
            </a>

            <a href="https://sergiocarracedo.es//2020/05/09/js-unary-operators-and-taking-advantage/" rel="prev" class="nav-text">
              <i class="fa fa-arrow-left"></i> Javascript unary operators: Taking advantage using them
            </a>
          </div>
        
      </div>
      <div class="prev col-xs-6">
        
          <div class="nav-next">
            <a href="https://sergiocarracedo.es//2020/04/05/slimbook-prox15-first-impressions/" rel="next" class="nav-cover">
              <img src="/images/slimbookprox15/teaser_cover.jpg">
            </a>

            <a href="https://sergiocarracedo.es//2020/04/05/slimbook-prox15-first-impressions/" rel="next" class="nav-text">
              Slimbook ProX 15: First Impressions <i class="fa fa-arrow-right"></i>
            </a>
          </div>
        
      </div>
    </div>
  </div>
</div>

<div class="post-comments container-fluid-1200">
    <div id="disqus_thread">To show the comments is mandatory accept cookie policy.</div>
</div>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<div id="post-aboutme">
  <div class="me container-fluid">
    <div class="grid-row">
      <div class="col-xs-12 mb-5">
        <div class="social">
  <a href="mailto:info@sergiocarracedo.es" class="social-link" title="info@sergiocarracedo.es">
    <i class="fas fa-envelope"></i>
  </a>
  <a href="https://github.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-github"></i>
  </a>
  <a href="https://www.drupal.org/u/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-drupal"></i>
  </a>

  <a href="http://www.linkedin.com/in/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-linkedin"></i>
  </a>
  <a href="https://www.twitter.com/sergiocarracedo" class="social-link" target="_blank">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="http://www.last.fm/user/gasman40" class="social-link" target="_blank">
    <i class="fab fa-lastfm"></i>
  </a>
  <a href="http://sergiocarracedo.tumblr.com/" class="social-link" target="_blank">
    <i class="fab fa-tumblr"></i>
  </a>
</div>

      </div>
    </div>
  </div>

  <div class="claim container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <h3>Front-end and back-end developer.<br />#formula1, good conversations and small details lover.</h3>
      </div>
    </div>
  </div>

  <div class="container-fluid-1440">
    <div class="grid-row">
      <div class="col-xs-12">
        <a href="/" class="back">
          Home
        </a>
      </div>
    </div>
  </div>

</div>


    </div>


</div>

</body>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<script src="/js/jquery.min.js"></script>
<script src="/js/sergiocarracedo.js"></script>


<link href="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css" rel="stylesheet">

<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
    <script>
      window.addEventListener("load", function(){
        window.cookieconsent.initialise({
          "palette": {
            "popup": {
              "background": "#004262",
              "text": "#fff"
            },
            "button": {
              "background": "#8ec760",
              "text": "#ffffff"
            }
          },
          "type": "opt-out",
          "content": {
            "message": "Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",
            "allow": "Ok, continua",
            "deny": "Nada de cookies",
            "link": "Saber más",
            "href": "https://sergiocarracedo.es/cookies.html",
          },
          "onStatusChange": function(status, chosenBefore) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          },
          "onInitialise" : function(status) {
            if (status == 'allow') {
               runCookiesAllowed()
            }
          }
        })
      });
    </script>


</html>
