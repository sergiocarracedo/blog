---
interface Props {
  images?: string;
  cols?: number;
}

function parseImages(imagesProp: string | undefined): string[] {
  if (!imagesProp) {
    return [];
  }
  try {
    const parsed = JSON.parse(imagesProp);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

const { images: imagesProp, cols = 3 } = Astro.props;
const imageUrls = parseImages(imagesProp);
const validCols = Math.max(1, Math.min(6, cols));

if (!imageUrls || imageUrls.length === 0) {
  throw new Error('Gallery must have at least one image');
}

// Render slot content to get processed image sources
const slotContent = await Astro.slots.render('default');

// Extract img src attributes from the rendered HTML
const srcRegex = /<img[^>]+src="([^"]+)"/g;
const processedImages: string[] = [];
let match;
while ((match = srcRegex.exec(slotContent)) !== null) {
  processedImages.push(match[1]);
}

// Use processed images if available, otherwise fall back to raw URLs
const images = processedImages.length > 0 ? processedImages : imageUrls;
---

<div class="gallery-wrapper" data-gallery-container>
  <div class="gallery-grid" style={`--gallery-cols: ${validCols}`}>
    {
      images.map((src: string, index: number) => (
        <img
          src={src}
          alt={`Gallery image ${index + 1}`}
          class="gallery-image"
          data-gallery-index={index}
          data-gallery-total={images.length}
        />
      ))
    }
  </div>

  <div class="gallery-modal-overlay" data-gallery-overlay>
    <div class="gallery-modal-content" data-gallery-modal>
      <button class="gallery-modal-close" aria-label="Close gallery" data-gallery-close> ✕ </button>

      <button
        class="gallery-modal-nav gallery-modal-prev"
        aria-label="Previous image"
        data-gallery-prev
      >
        ←
      </button>

      <div class="gallery-modal-image-container">
        <img src="" alt="Gallery image" class="gallery-modal-image" data-gallery-modal-image />
      </div>

      <button
        class="gallery-modal-nav gallery-modal-next"
        aria-label="Next image"
        data-gallery-next
      >
        →
      </button>

      <div class="gallery-modal-counter" data-gallery-counter></div>
    </div>
  </div>
</div>

<script>
  class GalleryController {
    constructor(containerElement) {
      this.container = containerElement;
      this.overlay = this.container.querySelector('[data-gallery-overlay]');
      this.modal = this.container.querySelector('[data-gallery-modal]');
      this.modalImage = this.container.querySelector('[data-gallery-modal-image]');
      this.counter = this.container.querySelector('[data-gallery-counter]');
      this.closeBtn = this.container.querySelector('[data-gallery-close]');
      this.prevBtn = this.container.querySelector('[data-gallery-prev]');
      this.nextBtn = this.container.querySelector('[data-gallery-next]');
      this.galleryImages = this.container.querySelectorAll('.gallery-image');

      // Extract actual image sources from rendered img elements
      this.imageSources = Array.from(this.galleryImages).map((img) => img.getAttribute('src'));

      // Move modal overlay to body (portal pattern) to escape any positioning context
      if (this.overlay && this.overlay.parentElement !== document.body) {
        document.body.appendChild(this.overlay);
      }

      this.init();
    }

    init() {
      // Image click handlers
      this.galleryImages.forEach((img, index) => {
        img.addEventListener('click', () => this.open(index));
        img.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.open(index);
          }
        });
        img.style.cursor = 'pointer';
        img.setAttribute('tabindex', '0');
        img.setAttribute('role', 'button');
      });

      // Modal interaction handlers
      this.closeBtn.addEventListener('click', () => this.close());
      this.prevBtn.addEventListener('click', () => this.prev());
      this.nextBtn.addEventListener('click', () => this.next());
      this.overlay.addEventListener('click', (e) => {
        if (e.target === this.overlay) {
          this.close();
        }
      });

      // Prevent modal from closing when clicking content
      this.modal.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => this.handleKeydown(e));
    }

    open(index) {
      this.selectedIndex = index;
      this.updateModal();
      this.overlay.classList.add('gallery-modal-open');
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.selectedIndex = null;
      // Animate out before removing
      this.overlay.style.animation = 'fadeOut 0.3s ease forwards';
      setTimeout(() => {
        this.overlay.classList.remove('gallery-modal-open');
        this.overlay.style.animation = '';
        document.body.style.overflow = '';
      }, 300);
    }

    prev() {
      if (this.selectedIndex === null) return;
      this.selectedIndex =
        (this.selectedIndex - 1 + this.imageSources.length) % this.imageSources.length;
      this.updateModal();
    }

    next() {
      if (this.selectedIndex === null) return;
      this.selectedIndex = (this.selectedIndex + 1) % this.imageSources.length;
      this.updateModal();
    }

    updateModal() {
      const src = this.imageSources[this.selectedIndex];
      this.modalImage.src = src;
      this.modalImage.alt = `Gallery image ${this.selectedIndex + 1}`;
      this.counter.textContent = `${this.selectedIndex + 1} / ${this.imageSources.length}`;
    }

    handleKeydown(e) {
      if (this.selectedIndex === null) return;

      if (e.key === 'Escape') {
        this.close();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        this.prev();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        this.next();
      }
    }
  }

  // Initialize gallery when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const galleryContainers = document.querySelectorAll('[data-gallery-container]');
    galleryContainers.forEach((container) => {
      new GalleryController(container);
    });
  });

  // Also initialize if already loaded (for SPAs or dynamic content)
  const galleryContainers = document.querySelectorAll('[data-gallery-container]');
  if (galleryContainers.length > 0) {
    galleryContainers.forEach((container) => {
      new GalleryController(container);
    });
  }
</script>
