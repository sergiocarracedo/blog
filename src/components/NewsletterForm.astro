---
import { Icon } from 'astro-icon/components';
interface Props {
  placement?: 'footer' | 'toast';
}

const { placement = 'footer' } = Astro.props;
---

<newsletter-form data-placement={placement} class="block">
  <form class="w-full" data-newsletter-form>
    <div class="flex flex-col gap-3">
      <div class="flex items-center gap-2">
        <Icon name="outline/mail-outline" />
        <h3 class="m-0 text-xl font-bold text-primary">Stay Updated</h3>
      </div>

      <p class="m-0 text-sm text-slate-600">
        Get monthly digests of new posts delivered to your inbox
      </p>

      <div class="flex flex-col gap-2 sm:flex-row sm:items-stretch">
        <input
          type="email"
          name="email"
          placeholder="your@email.com"
          required
          class="w-full rounded-lg border-2 border-primary-lighter bg-white px-3.5 py-2.5 text-[15px] transition-all duration-200 ease-in-out placeholder:text-slate-400 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary-lighter sm:min-w-50 sm:flex-1"
          aria-label="Email address"
        />

        <button type="submit" class="btn flex w-full items-center justify-center gap-2 sm:w-auto">
          <span data-newsletter-button-text>Subscribe</span>
        </button>
      </div>

      <div
        data-newsletter-message
        class="hidden rounded-md border px-2 py-2 text-sm"
        role="status"
        aria-live="polite"
      >
      </div>
    </div>
  </form>
</newsletter-form>

<script>
  class NewsletterForm extends HTMLElement {
    form!: HTMLFormElement;
    emailInput!: HTMLInputElement;
    submitButton!: HTMLButtonElement;
    messageEl!: HTMLElement;
    buttonTextEl!: HTMLElement;

    constructor() {
      super();

      this.form = this.querySelector('form')!;
      this.emailInput = this.querySelector<HTMLInputElement>('input[name="email"]')!;
      this.submitButton = this.querySelector<HTMLButtonElement>('button[type="submit"]')!;
      this.messageEl = this.querySelector<HTMLElement>('[data-newsletter-message]')!;
      this.buttonTextEl = this.querySelector<HTMLElement>('[data-newsletter-button-text]')!;

      this.form.addEventListener('submit', this.handleSubmit.bind(this));
    }

    async handleSubmit(e: Event) {
      e.preventDefault();

      const email = this.emailInput.value.trim();

      if (!email || !this.isValidEmail(email)) {
        this.showMessage('Please enter a valid email address', 'error');
        return;
      }

      this.setLoading(true);
      this.showMessage('Subscribing...', 'loading');

      try {
        const response = await fetch('/api/newsletter/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok) {
          this.showMessage('Success! Check your email to confirm your subscription.', 'success');
          this.emailInput.value = '';
          
          // Emit success event for toast
          const successEvent = new CustomEvent('newsletter:success');
          document.dispatchEvent(successEvent);
          
          // Close toast popup after short delay
          const placement = this.getAttribute('data-placement');
          if (placement === 'toast') {
            setTimeout(() => {
              const toast = document.querySelector('newsletter-toast');
              if (toast && typeof (toast as any).hide === 'function') {
                (toast as any).hide();
              }
            }, 2000);
          }
        } else {
          this.showMessage(data.error || 'Something went wrong. Please try again.', 'error');
        }
      } catch (error) {
        this.showMessage('Network error. Please check your connection and try again.', 'error');
      } finally {
        this.setLoading(false);
      }
    }

    isValidEmail(email: string): boolean {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    showMessage(message: string, type: 'success' | 'error' | 'loading') {
      const base = ['rounded-md', 'border', 'px-2', 'py-2', 'text-sm', 'block'];
      const variants: Record<typeof type, string[]> = {
        success: ['bg-emerald-100', 'text-emerald-900', 'border-emerald-500'],
        error: ['bg-red-100', 'text-red-900', 'border-red-500'],
        loading: ['bg-blue-100', 'text-blue-900', 'border-blue-500'],
      };

      const allVariantClasses = Object.values(variants).flat();

      this.messageEl.textContent = message;
      this.messageEl.classList.remove('hidden', ...allVariantClasses);
      this.messageEl.classList.add(...base, ...variants[type]);
    }

    setLoading(loading: boolean) {
      this.submitButton.disabled = loading;
      this.emailInput.disabled = loading;
      this.buttonTextEl.textContent = loading ? 'Subscribing...' : 'Subscribe';
    }
  }

  customElements.define('newsletter-form', NewsletterForm);
</script>
