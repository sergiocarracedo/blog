<!doctype html><html><head><meta charset=utf-8><meta content="IE=edge,chrome=1" http-equiv=x-ua-compatible><meta content="width=device-width,minimum-scale=1" name=viewport><title>Sergio Carracedo | Entidad con propietario en Laravel 5.4</title><meta content="yes" name=apple-mobile-web-app-capable><meta content="black-translucent" name=apple-mobile-web-app-status-bar-style><meta content="Sergio Carracedo's personal page and blog" name=description><meta content="Sergio Carracedo" name=author><link href=/favicon.png rel=icon><meta property="og:title" content="Entidad con propietario en Laravel 5.4"><meta property="og:description" content="Recientemente he iniciado un proyecto con Laravel 5.4, en el que algunos de mis modelos tienen un propietario, es decir, los crea un usuario y sólo el tiene acceso para ver o editar los datos de su entidad.
La forma más simple que he encontrado es hacer uso de las posiblilidades que Laravel nos ofrece mediante los middleware.
En primer lugar extendemos el Model que nos provee Elocuent
<?php namespace App; use Illuminate\Database\Eloquent\Model; class OwnableModel extends Model { public function getOwnerId() { return isset($this->user_id) ?"><meta property="og:type" content="article"><meta property="og:url" content="https://sergiocarracedo.es/2017/03/07/entidad-con-propietario-en-laravel-54/"><meta property="og:image" content="https://sergiocarracedo.es/2017/03/07/entidad-con-propietario-en-laravel-54/pexels-photo-132907_0_huf559abf65cff05b97b5774b6ae802595_269852_1920x1080_fill_q75_box_center.jpeg"><meta name=twitter:image content="https://sergiocarracedo.es/2017/03/07/entidad-con-propietario-en-laravel-54/pexels-photo-132907_0_huf559abf65cff05b97b5774b6ae802595_269852_1920x1080_fill_q75_box_center.jpeg"></meta><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2017-03-07T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"></meta><link rel=canonical href=https://sergiocarracedo.es/2017/03/07/entidad-con-propietario-en-laravel-54/><link href=https://sergiocarracedo.es/scss/main.b343c08ef2cb6c27d6d3e0f5b336ce538d71ecf6189085c94f37eca6b47df91e.css integrity="sha256-s0PAjvLLbCfW0+D1szbOU41x7PYYkIXJTzfsprR9+R4=" rel=stylesheet><link href=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css rel=stylesheet type=text/css></head><body><header class=web-header><h2><a class=back-to-home href=/ title="Back to home"><i class="fas fa-home"></i><div class=back-to-home__content><span class=back-to-home__action>Back to home</span><div class=back-to-home__title><img alt="Sergio Carracedo" class=avatar src=/i/sergiocarracedo_hu6caa808ff324b89bfea4b9d7d1c850ee_80590_100x100_fit_q75_box.jpg><h4>Sergio Carracedo</h4></div></div></a></h2><div class=web-header__page-title><span>Entidad con propietario en Laravel 5.4</span></div><div class=theme-switch><i class="theme-switch__theme fas fa-sun" id=theme-switch-light title="Switch to light theme"></i>
<i class="theme-switch__theme fas fa-moon" id=theme-switch-dark title="Switch to dark theme"></i></div></header><div class=main-content><article class="post post--single"><div class="post__main wrapper-1200"><aside class=post__metadata><time class=post__date datetime=2017-03-07><i class="far fa-calendar-alt"></i> Mar 7, 2017</time><div class=post__tags></div><span class=post__reading-time><i class="far fa-clock"></i> 2 minutes read</span></aside><header class=post__header><h1 class=post__title>Entidad con propietario en Laravel 5.4</h1></header><figure class=post__cover><img src=/2017/03/07/entidad-con-propietario-en-laravel-54/pexels-photo-132907_0_huf559abf65cff05b97b5774b6ae802595_269852_1200x400_fill_q75_box_center.jpeg alt="Entidad con propietario en Laravel 5.4" width=1200 height=400></figure><div class=post__content><p>Recientemente he iniciado un proyecto con <strong>Laravel 5.4</strong>, en el que algunos de mis modelos tienen un propietario, es decir, los crea un usuario y sólo el tiene acceso para ver o editar los datos de su entidad.</p><p>La forma más simple que he encontrado es hacer uso de las posiblilidades que Laravel nos ofrece mediante los <em>middleware.</em></p><p>En primer lugar extendemos el <em>Model</em> que nos provee <em>Elocuent</em></p><pre tabindex=0><code>&lt;?php

namespace App;
use Illuminate\Database\Eloquent\Model;

class OwnableModel extends Model {

  public function getOwnerId() {
    return isset($this-&gt;user_id) ? $this-&gt;user_id : null;
  }

  public function checkIsOwner($user_id) {
    return $this-&gt;getOwnerId() == $user_id;
  }
}
</code></pre><p>Esta clase tiene dos métodos: </p><p><code>getOwnerID()</code> que se encarga de devolver el id del propietario de la entidad (por defecto usa el campo user_id)</p><p><code>checkIsOwner($user_id)</code> devuelve TRUE si el user_id el el propietario de la entidad</p><p>Ahora el modelo concreto que queramos controlar debe extender de <em>OwnableModel</em> en lugar de <em>Model</em>.</p><p>Los dos métodos mencionados podremos sobreescribirlos para adaptarlos a nuestras necesidades.</p><p>Ahora tenemos que crear el <em>middleware</em>, en la carpeta <em>app/Http/Middleware</em> creamos el archivo <em>AbortIfNotOwner.php</em> con el siguente contenido.</p><pre tabindex=0><code>&lt;?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Support\Facades\Auth;

class AbortIfNotOwner {
  /**
   * Handle an incoming request.
   *
   * @param  \Illuminate\Http\Request $request
   * @param  \Closure $next
   * @return mixed
   */
  public function handle($request, Closure $next) {
    $isOwner = TRUE;
    foreach ($request-&gt;route()-&gt;parameters() as $model) {
      if ($model instanceof \App\OwnableModel &amp;&amp; !$model-&gt;checkIsOwner(Auth::id())) {
        $isOwner = FALSE;
      }
    }

    if (!$isOwner) {
      return response(&#39;Unauthorized.&#39;, 401);
    }

    return $next($request);

  }
}
</code></pre><p>Este middleware debemos añadirlo a las rutas que deseemos comprobar que el dueño de la entidad es el que accede a ella.</p><pre tabindex=0><code>Route::get(&#39;/ruta/{entity}/&#39;, [ &#39;uses&#39; =&gt; &#39;RutaController@index&#39;, ])-&gt;middleware(&#39;owner&#39;);
</code></pre><p>Con estos sencillos pasos tenemos protegida la entidad de forma que si un usuario intenta acceder a una entidadad de las que no es propietario recibirá un error HTTP 401.</p></div></div><aside class=post__nav-wrapper><div class=wrapper-1200><div class="post-nav post-nav--prev"><a class=post-nav__link href="https://sergiocarracedo.es/2017/03/15/introduccion-vuejs/?ref=footer"><div class=post-nav__cover><img alt=.NextPage.Title src=/2017/03/15/introduccion-vuejs/pexels-photo-196160_hucc9370dd5a2fecb6b12ae8170d908851_547707_200x120_fill_q75_box_center.jpeg></div><div class=post-nav__title>Introducción a Vue.js</div></a></div><div class=blog-link><a class=btn href=https://sergiocarracedo.es/blog>All Blog posts</a></div><div class="post-nav post-nav--next"><a class=post-nav__link href="https://sergiocarracedo.es/2017/03/03/algo-se-mueve-en-vigo/?ref=footer"><div class=post-nav__cover><img alt=.PrevPage.Title class=post-nav__cover src=/2017/03/03/algo-se-mueve-en-vigo/pexels-photo-209728_hu68cf42ad52168dbe6249a14b099b8cbe_8079290_200x120_fill_q75_box_center.jpeg></div><div class=post-nav__title>Algo se mueve en Vigo</div></a></div></div></aside><aside class=post__search-wrapper><div class=wrapper-1200>Search in this blog:<form class=search-form action=https://sergiocarracedo.es/search method=get><label hidden for=search-input>Search</label>
<input type=text id=search-input name=query placeholder=Search class=search-form__input>
<button class=search-form__button>
<i class="fas fa-search"></i></button></form></div></aside><aside class=post__comments><div class=wrapper-1200><div id=disqus_thread>To show the comments is mandatory accept cookie policy.</div></div></aside></article></div><footer class=web-footer><div class=wrapper-1200><div class=web-footer__left><div class=me><div class=me__avatar><img alt="Sergio Carracedo" src=/i/sergiocarracedo_hu6caa808ff324b89bfea4b9d7d1c850ee_80590_170x170_fit_q75_box.jpg></div><div class=me__titles><h1>Sergio Carracedo</h1><h2>Senior Fullstack developer.</h2><h3>Always learning, cats, good conversations and small details lover.</h3></div></div></div><div class=web-footer__right><nav role=main class=menu><ul><li class=menu__item><a href=https://sergiocarracedo.es/>Home</a></li><li class=menu__item><a href=https://sergiocarracedo.es/blog>Blog</a></li></ul></nav><div class=social><a class=social__link href=http://www.linkedin.com/in/sergiocarracedo target=_blank title=LinkedIn style=animation-delay:2s><i class="fab fa-linkedin"></i></a>
<a class=social__link href=mailto:hi+blog@sergiocarracedo.es target=_blank title=Email style=animation-delay:1.9333333333333333s><i class="fas fa-envelope"></i></a>
<a class=social__link href=https://github.com/sergiocarracedo target=_blank title=GitHub style=animation-delay:1.8666666666666667s><i class="fab fa-github"></i></a>
<a class=social__link href=https://www.drupal.org/u/sergiocarracedo target=_blank title=Drupal style=animation-delay:1.8s><i class="fab fa-drupal"></i></a>
<a class=social__link href=https://www.twitter.com/sergiocarracedo target=_blank title=Twitter style=animation-delay:1.7333333333333334s><i class="fab fa-twitter"></i></a>
<a class=social__link href=http://www.last.fm/user/gasman40 target=_blank title=Last.fm style=animation-delay:1.6666666666666667s><i class="fab fa-lastfm"></i></a>
<a class=social__link href=http://sergiocarracedo.tumblr.com/ target=_blank title=Tumblr style=animation-delay:1.6s><i class="fab fa-tumblr"></i></a></div></div></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-87X78TXEGE"></script>
<script>function runGA(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-87X78TXEGE")}</script><script>function runDisqus(){(function(){var e=document,t=e.createElement("script");t.src="https://sergiocarracedo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()}</script><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js></script>
<script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#004262",text:"#fff"},button:{background:"#8ec760",text:"#ffffff"}},type:"opt-out",content:{message:"Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",allow:"Ok, continua",deny:"Nada de cookies",link:"Saber más",href:"https://sergiocarracedo.es/cookies"},onStatusChange:function(e){e=="allow"&&runCookiesAllowed()},onInitialise:function(e){e=="allow"&&runCookiesAllowed()}})})</script><script>addEventListener("scroll",e=>{let t=document.getElementsByTagName("body")[0];t&&window.scrollY>10?t.classList.add("not-in-top"):t.classList.remove("not-in-top")});function runCookiesAllowed(){runGA(),runDisqus()}</script><script integrity="sha256-iiQa3rTjie3Ydsr4WEu2+aLDTaxKKVR3ZTwTYrRUjXs=" src=https://sergiocarracedo.es/js/theme.8a241adeb4e389edd876caf8584bb6f9a2c34dac4a295477653c1362b4548d7b.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script>
<script integrity="sha256-LVPRt2Ca+MpOY1KztdII4jRv+U0kJBcBZEvwhZr2a4Y=" src=https://sergiocarracedo.es/js/search.2d53d1b7609af8ca4e6352b3b5d208e2346ff94d24241701644bf0859af66b86.js></script></body></html>