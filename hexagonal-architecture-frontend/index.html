<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible><meta content="width=device-width,minimum-scale=1" name=viewport><title>Sergio Carracedo | A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend</title>
<meta content="yes" name=mobile-web-app-capable><meta content="black-translucent" name=apple-mobile-web-app-status-bar-style><meta content="Sergio Carracedo's personal page and blog" name=description><meta content="Sergio Carracedo" name=author><link href=https://sergiocarracedo.es//index.xml rel=alternate title="Sergio Carracedo" type=application/rss+xml><link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/site.webmanifest rel=manifest><link color=#5bbad5 href=/safari-pinned-tab.svg rel=mask-icon><meta content="#da532c" name=msapplication-TileColor><meta content="#ffffff" name=theme-color><link crossorigin href="https://fonts.googleapis.com/css2?family=Rozha+One:wght@400;500;600;700&display=swap" rel=preconnect><link crossorigin href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;500;600;700&display=swap" rel=preconnect><link crossorigin href="https://fonts.googleapis.com/css2?family=Allura:wght@400;500;600;700&display=swap" rel=preconnect><meta property="og:title" content="A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend"><meta property="og:description" content="Hexagonal architecture is a software design pattern based on the separation of responsibilities. The goal is to decouple the business logic (domain) and the application from other external interfaces.
Simplifying in hexagonal architecture we communicate the core of the app (domain + application) with the external elements using ports and adapters. A port lives in the core, it is the interface any external code must use to interact with the core (or the core with the external code), the adapter is the external piece of code that follows the port interface and execute the tasks, get the data, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://sergiocarracedo.es/hexagonal-architecture-frontend/"><meta property="og:image" content="https://sergiocarracedo.es/hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu1466182537865770861.jpg"><meta name=twitter:image content="https://sergiocarracedo.es/hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu1466182537865770861.jpg"></meta><meta property="article:section" content="blog">
<meta property="article:published_time" content="2024-05-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"></meta>
<link href=https://sergiocarracedo.es/hexagonal-architecture-frontend/ rel=canonical><link href=https://sergiocarracedo.es/scss/main.min.c6aeadd0f64f9e58a5f36b759b3c5f69f04adcbaf95c581a64fdd28dfd1410e8.css integrity="sha256-xq6t0PZPnlil82t1mzxfafBK3Lr5XFgaZP3Sjf0UEOg=" rel="stylesheet preconnect"><link as=style href=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css rel="stylesheet preload" type=text/css></head><body><header class="web-header background-paper-secondary"><h2><a class=back-to-home href=/ title="Back to home"><i class="fas fa-home"></i><div class=back-to-home__content><span class=back-to-home__action>Back to home</span><div class=back-to-home__title><img alt="Sergio Carracedo" class=avatar src=/i/sergiocarracedo_hu15161314200389136556.jpg width=100 height=100><h4>Sergio Carracedo</h4></div></div></a></h2><div class=web-header__page-title><span>A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend</span></div><div class=theme-switch><i class="theme-switch__theme fas fa-sun" id=theme-switch-light title="Switch to light theme"></i>
<i class="theme-switch__theme fas fa-moon" id=theme-switch-dark title="Switch to dark theme"></i></div></header><div class=main-content><article class="post post--single"><div class="post__main wrapper-1200"><aside class=post__metadata><time class=post__date datetime=2024-05-20><i class="far fa-calendar-alt"></i> May 20, 2024
</time><a href=https://sergiocarracedo.es/tags/typescript class=post__tag><span>typescript</span>
</a><a href=https://sergiocarracedo.es/tags/architecture class=post__tag><span>architecture</span>
</a><a href=https://sergiocarracedo.es/tags/clean%20code class=post__tag><span>clean code</span>
</a><a href=https://sergiocarracedo.es/tags/hexagonal class=post__tag><span>hexagonal</span>
</a><span class=post__reading-time><i class="far fa-clock"></i> 14 minutes read</span></aside><header class=post__header><h1 class=post__title>A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend</h1></header><div class=post__cover><figure class=image-caption><img src=/hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu72194286598831100.jpg alt="A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend" title="A real case: why hexagonal architecture, decoupling, and Dependency injection can be very useful in the frontend" width height=367 srcset="/hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu14705759240041525720.webp 458w, /hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu14826979340264322167.webp 768w, /hexagonal-architecture-frontend/shaah-shahidh--subrrYxv8A-unsplash_hu11253261588105230906.webp 1200w" sizes="(max-width: 458px) 100vw, (max-width: 768px) 100vw, 1200px"></figure></div><div class=post__content><p>Hexagonal architecture is a software design pattern based on the separation of responsibilities. The goal is to decouple the business logic (domain) and the application from other external interfaces.</p><p>Simplifying in hexagonal architecture we communicate the core of the app (domain + application) with the external elements using ports and adapters. A <strong>port</strong> lives in the core, it is the interface any external code must use to interact with the core (or the core with the external code), the <strong>adapter</strong> is the external piece of code that follows the port interface and execute the tasks, get the data, etc.</p><blockquote><p>You can imagine the port is a space reserved only for an exact type of vessel. The vessel only can enter the port and dock if the load/unload doors are of an expected size and are in the correct position. Multiple vessels can fit in a port and vessels can be replaced, but ports are unique and can not be moved.</p></blockquote><p><figure class=image-caption><img src=/hexagonal-architecture-frontend/hexagonal_hu17174070422787841319.jpg alt=hexagonal.png title width=1100 height=499 srcset="/hexagonal-architecture-frontend/hexagonal_hu2262804375426980488.webp 458w, /hexagonal-architecture-frontend/hexagonal_hu3350914854686736968.webp 768w, /hexagonal-architecture-frontend/hexagonal_hu17783323466113250514.webp 1257w" sizes="(max-width: 458px) 100vw, (max-width: 768px) 100vw, 1257px"><figcaption></figcaption></figure></p><p>A key concept is that the core doesn&rsquo;t know anything about how are the external internals. The port defines the vessel doors positions but doesn&rsquo;t care about how the load is stored in the vessel.</p><p>In this case, we will also use the <a href=https://medium.com/@pererikbergman/repository-design-pattern-e28c0f3e4a30>repository pattern</a> (that fits very well with hexagonal as defines a centralized and abstract way of accessing data and it is a very common pattern), and the <a href=https://en.wikipedia.org/wiki/Dependency_injection>dependency injection principle</a> that allows us to create decoupled (or loosely coupled) software. Simplifying again, it allows us to replace an adapter with another one that follows the same port interface.</p><p>Let&rsquo;s see it in action with a small (and typical) example:</p><p>Your domain (core) needs to get a list of users with a name, so you define the port that is a repository. The port defined a method to do that: <code>getUsersByName(name: string): User[]</code> In English, defines that the adapter must provide a method called `getUsersByName&rsquo; that gets a name and should return the list of the users that match that name.</p><blockquote><p>If you want to go further in those patterns, there is a lot of documentation on the internet. I want to focus the post on a real case</p></blockquote><h2 id=a-real-case>A real case</h2><h3 id=the-initial-context>The initial context</h3><p>We have a single web application (frontend) that works for different clients (tenants), that application uses a backend that provides the menu data. The backend returns something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Main Menu&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;main&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;items&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Home&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Dashboards&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;dashboards&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;dashboards&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;items&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Home&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;dashboards-home&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;/dashboards&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Config 🚫&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;dashboards-config&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;/dashboards-config&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Advanced Reports&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;advanced_reports&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;items&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Sales Analysis&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;/sales_analysis&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;is_staff&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The front end implements partially the repository pattern as it just returns the data the backend provides without more manipulation than remove the first level in the tree (the main menu item). The view executes the repository call using a service, that again, just returns the same information that it gets from the repository.</p><p><figure class=image-caption><img src=/hexagonal-architecture-frontend/legacy_hu16419711717526729745.jpg alt="legacy architecture" title width=1100 height=499 srcset="/hexagonal-architecture-frontend/legacy_hu4318573057780875945.webp 458w, /hexagonal-architecture-frontend/legacy_hu4063242804681056590.webp 768w, /hexagonal-architecture-frontend/legacy_hu3625036641017223865.webp 1257w" sizes="(max-width: 458px) 100vw, (max-width: 768px) 100vw, 1257px"><figcaption></figcaption></figure></p><h3 id=the-issues>The issues</h3><p>This &ldquo;architecture&rdquo; works, but have some issues can create serious problems in the future:</p><ul><li><strong>The data structure is coupled to the backend data</strong>: All the data flows from the backend to the view using the same interfaces, if the backend changes just the name of a property we need to follow the data flow in our code until the view changes it in all the places.</li><li><strong>The title string includes an emoji to allow users to visualize when a menu item is only for staff users</strong>: That information is also provided in the <code>is_staff</code> property, if we want to expose a menu item to the regular users we need to change it in 2 places, and that is never a good idea.</li><li><strong>Visuals are defined in the backend</strong>: The name of the icon to use is defined in the backend. Unless the icon would be an app (backend + frontend) global concept it is not a good idea to pass that value front the backend.</li><li><strong>No domain</strong>: there is no domain, or at least no explicit one. Logic is applied in the view (that it is not bad <em>per se</em>, but if the logic is related to the business rules, it must live in the domain)</li></ul><h3 id=the-problem>The problem</h3><p>Because of different reasons the company decided to create a new version of the backend. This new backend (called v2) will not be retro-compatible with the legacy one, but it will represent semantically the same entities.</p><p>The menu endpoint will return the same menu (it will provide more features) but the new endpoint response structure is completely different:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuName&#34;</span>: <span style=color:#e6db74>&#34;Dashboards&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemId&#34;</span>: <span style=color:#ae81ff>9</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemTitle&#34;</span>: <span style=color:#e6db74>&#34;Home&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemLink&#34;</span>: <span style=color:#e6db74>&#34;/dashboards&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuId&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuParentId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard.home&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuName&#34;</span>: <span style=color:#e6db74>&#34;Dashboards&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemId&#34;</span>: <span style=color:#ae81ff>9</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemTitle&#34;</span>: <span style=color:#e6db74>&#34;Sales analysis&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemLink&#34;</span>: <span style=color:#e6db74>&#34;/sales_analysis&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuId&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuParentId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard.sales_analysis&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuName&#34;</span>: <span style=color:#e6db74>&#34;Dashboards&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemId&#34;</span>: <span style=color:#ae81ff>9</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemTitle&#34;</span>: <span style=color:#e6db74>&#34;Config&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemLink&#34;</span>: <span style=color:#e6db74>&#34;/dashboards-config&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemStateId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuId&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuParentId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard.sales_analysis&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuName&#34;</span>: <span style=color:#e6db74>&#34;Dashboards&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemId&#34;</span>: <span style=color:#ae81ff>9</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemTitle&#34;</span>: <span style=color:#e6db74>&#34;Sales analysis&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemLink&#34;</span>: <span style=color:#e6db74>&#34;/sales_analysis&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuId&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuParentId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemInternalName&#34;</span>: <span style=color:#e6db74>&#34;dashboard.sales_analysis&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuPosition&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuName&#34;</span>: <span style=color:#e6db74>&#34;Main&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemId&#34;</span>: <span style=color:#ae81ff>11</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemTitle&#34;</span>: <span style=color:#e6db74>&#34;Home&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemPosition&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemLink&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemStateId&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuInternalName&#34;</span>: <span style=color:#e6db74>&#34;home&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuParentId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;menuItemInternalName&#34;</span>: <span style=color:#e6db74>&#34;home&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>The new backend endpoint returns the menu items and its parent menu data in the same row. The structure is flat (no nested items). Another difference is the <code>is_staff</code>, is still there, but it’s a specific value for the <code>menuItemStateId</code> property. No icon name, but now we have an <code>internalId</code> as a semantic unique id.</p><h4 id=things-can-become-harder>Things can become harder</h4><p>The new backend will not replace the legacy one, at least not in the next months, clients will be migrated slowly to the new backend. So some clients will use the legacy backend and another will use the new one. That means we will have both backends working at the same time for months.</p><p>As the data returned by both backends is very different seems tough to use the same frontend code to render the menu for all the clients, right? (not really as we will see later)</p><p>A possible solution is to create different menu-related components, code, etc. depending on the backend version adapting our application to them, this can work, but means we will need to duplicate a lot of code, for example, the views, the services, etc making the maintenance harder.</p><h3 id=decoupling-us-from-the-backend>Decoupling us from the backend</h3><p>Let&rsquo;s forget for a while how is the data the backend(s) returns, and think in what we want to represent from the point of view of our application.</p><p>We want to represent a menu that can have items with children items (and no link) and items with links a no children. Then let&rsquo;s create a model, models in our case, in our domain as entities which will represent exactly that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;disabled&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;only_for_staff&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;open&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Menu</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>URL</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>State</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;open&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>position</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>Menu</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>MenuItem</span>)[] <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>values</span>: <span style=color:#66d9ef>MenuDto</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>internalName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>internalName</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>children</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>get</span> <span style=color:#a6e22e>onlyForStaff</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;only_for_staff&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MenuItem</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>State</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;open&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>position</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>menuId</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>values</span>: <span style=color:#66d9ef>MenuItemDto</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// hydrate the entity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>get</span> <span style=color:#a6e22e>isStaff</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;hidden&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>get</span> <span style=color:#a6e22e>external</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;http://&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is a simplified version of the entities, but you can see the idea. We have a <code>Menu</code> entity that can have children that can be <code>Menu</code> or <code>MenuItem</code> entities. The <code>MenuItem</code> entity has a <code>url</code> property that can be used to know if the item is a link or not.</p><p>We modeled the domain and our application layer (and views) can access to it.</p><blockquote><p>The key is: we modeled our menu independently of our backends&rsquo; data structures, we can use any backend that represents that entity to get the data independently of the structure.</p></blockquote><h3 id=the-port>The port</h3><p>We should create the port that will allow us to get the menu&rsquo;s data from the backend(s).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MenuRepo</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getMainMenu</span>(<span style=color:#a6e22e>states</span>: <span style=color:#66d9ef>State</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>(<span style=color:#a6e22e>MenuItem</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Menu</span>)[]<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The port defines how the repository should look like. In this case, we want a method that will return the main menu, filtered by state (<code>'disabled' | 'only_for_staff' | 'open'</code>).</p><h3 id=the-adapter-the-repositories-will-do-the-magic>The adapter. The repositories will do the magic</h3><p>We need to create the adapters that will get the data from the backend and transform it to our domain entities. We need an adapter, also called <strong>repository implementation</strong> for each backend (we could have even more for mocked data, stubs for testing, etc).</p><p>Remember, <strong>the repository implementation (adapter) is the one that knows the &ldquo;external to the core&rdquo; internals</strong>:</p><ul><li><strong>How to get the data</strong> at the infrastructure level: REST, Graphql, local storage, etc</li><li><strong>How to request the data</strong>: for example for an XHR request: headers, query params, URL, etc</li><li><strong>The returned data structure</strong> and <strong>how to transform it</strong> to the domain entities</li><li>How to <strong>handle errors, retries</strong>, etc</li><li>How to cache the data</li></ul><p>But again, the domain NEVER should not know about that.</p><p>For example, the domain <strong>must not know</strong> that to get items available only for staff users we need to pass the <code>menuItemStateId</code> param with the value<code>1</code>.</p><p><code>menuItemStateId</code> is an implementation detail. it only makes sense in repository implementation, not in the domain, the domain should know about the <code>onlyForStaff</code> meaning and the adapter should know how to get that information from the backend.</p><p>In this case (for backend v2) we need to pass a query param called <code>menuItemStateId</code> with the value <code>1</code> to get the staff-only items, but that is different for the legacy backend. Or for another backend that can use a different value for that filter, but the argument that represents what we want is still the same: <code>onlyForStaff</code>.</p><p>From the point of view of the layers on the right side the port&rsquo;s line in the workflow (Image above) do not matter how the data is retrieved, the only thing that matters is the data is returned as a domain entity. That is our contract.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// menu.legacy.repo.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// This type defines the shape of the data the backend returns. I do not include it here to put the focus on the data transformation into entities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LegacyMenuRepo</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MenuRepo</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getMainMenu</span>(<span style=color:#a6e22e>states</span>: <span style=color:#66d9ef>State</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>(<span style=color:#a6e22e>MenuItem</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Menu</span>)[]<span style=color:#f92672>&gt;</span> { <span style=color:#75715e>// 1️⃣ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>&lt;<span style=color:#f92672>Response</span>&gt;(<span style=color:#e6db74>&#39;tenant.company.com/get_menu&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backendMenu</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>json</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>backendMenu</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>backendMenu</span>))  
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>Response</span>)<span style=color:#f92672>:</span> (<span style=color:#a6e22e>MenuItem</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Menu</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// transform the response to the domain entities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#39;items&#39;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>response</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Menu</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>response.title</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>mapIcon</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span>), <span style=color:#75715e>// 2️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>mapImage</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>image</span>),  <span style=color:#75715e>// 2️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>mapState</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>state</span>),  <span style=color:#75715e>// 3️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>children</span>: <span style=color:#66d9ef>response.items.map</span>(<span style=color:#a6e22e>item</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>item</span>))
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MenuItem</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>response.title</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>mapIcon</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span>), <span style=color:#75715e>// 2️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>response.url</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>mapState</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>state</span>),  <span style=color:#75715e>// 3️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>menuId</span>: <span style=color:#66d9ef>response.menuId</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Things to put focus on:</p><ul><li>1️⃣: the method that receives the states&rsquo; argument is not used in the code: This is because the backend does not accept any filter, the legacy backend does the filtering using the backend context. But it ensures will only return the items the user can have access to.</li><li>2️⃣: Those map functions are in charge of providing the correct icon and image, now the backend does not provide that information, so our repository implementation should provide it. Remember <strong>the repository implementation (adapter) is the one that knows all the external internals</strong> and for the images the adapter knows that if the id is &ldquo;x&rdquo; should return the image &ldquo;y&rdquo; and the icon &ldquo;z&rdquo;</li><li>3️⃣: The <code>mapState</code> function behavior is similar to 2️⃣ but in this case, the backend returns a number that represents the state, the adapter should know how to map that number to the domain state, and that function can be reversed to know with the state should be sent to the backend.</li></ul><p>We need to implement the adapter for the &ldquo;new&rdquo; backend (v2):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// menu.v2.repo.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// This type defines the shape of the data the backend v2 returns. I do not include it here to put the focus on the data transformation into entities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stateMappings</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>number</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>State</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;disabled&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;only-for-staff&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;open&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stateMappingsReverse</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>number</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>State</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;disabled&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;only-for-staff&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;open&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>V2MenuRepo</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MenuRepo</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getMainMenu</span>(<span style=color:#a6e22e>states</span>: <span style=color:#66d9ef>State</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>(<span style=color:#a6e22e>MenuItem</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Menu</span>)[]<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>&lt;<span style=color:#f92672>Response</span>&gt;(<span style=color:#e6db74>&#39;menu.company.com/company/get&#39;</span>, { <span style=color:#75715e>// 1️⃣ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>params</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>menuItemStateId</span>: <span style=color:#66d9ef>states.map</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>stateMappingsReverse</span>[<span style=color:#a6e22e>state</span>]) <span style=color:#75715e>// 2️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backendMenu</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>json</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>backendMenu</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>backendMenu</span>))  
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>Response</span>)<span style=color:#f92672>:</span> (<span style=color:#a6e22e>MenuItem</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Menu</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Here the transformations from flat to nested are more complex (require more code lines) so I&#39;m going to ignore it in the example. Let&#39;s imagine it is done after this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// transform the response to the domain entities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#39;items&#39;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>response</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Menu</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>response.internalName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>response.title</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>mapIcon</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>internalName</span>), <span style=color:#75715e>// 3️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>mapImage</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>internalName</span>),  <span style=color:#75715e>// 3️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>stateMappings</span>[<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>menuStateId</span>], <span style=color:#75715e>// 4️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>children</span>: <span style=color:#66d9ef>response.items.map</span>(<span style=color:#a6e22e>item</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>responseToEntity</span>(<span style=color:#a6e22e>item</span>))
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MenuItem</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>internalName</span>: <span style=color:#66d9ef>response.id</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>response.title</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>icon</span>: <span style=color:#66d9ef>mapIcon</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>internalName</span>), <span style=color:#75715e>// 3️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>response.url</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>stateMappings</span>[<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>menuItemStateId</span>], <span style=color:#75715e>// 4️⃣
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>menuId</span>: <span style=color:#66d9ef>response.menuId</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Things to put the focus in the backend v2 repo implementation:</p><ul><li>1️⃣: The endpoint (even the domain) is different from the other repo. That is expected as it is a different backend.</li><li>2️⃣: Get need to convert the meaning of the filters to the backend meaning. The adapter knows that the backend expects a query param called <code>menuItemStateId</code> with the values <code>0</code>, <code>1</code>, or <code>2</code> to get the items with the state <code>disabled</code>, <code>only-for-staff</code>, or <code>open</code></li><li>3️⃣: We have mapping functions for the icons and images, but this function is different from the legacy one.</li><li>4️⃣: we convert the <code>menuItemStateId</code> and <code>menuStateId</code> to the domain state using the mappings.</li></ul><p>After the changes, the architecture looks like this:</p><p><figure class=image-caption><img src=/hexagonal-architecture-frontend/new-flow_hu12402881703959250486.jpg alt=new-flow.png title width=1100 height=499 srcset="/hexagonal-architecture-frontend/new-flow_hu8990543592400123253.webp 458w, /hexagonal-architecture-frontend/new-flow_hu12411035100835656533.webp 768w, /hexagonal-architecture-frontend/new-flow_hu15225306471289309686.webp 1257w" sizes="(max-width: 458px) 100vw, (max-width: 768px) 100vw, 1257px"><figcaption></figcaption></figure></p><p>Now we have 2 different adapters (one per backend) for the same port.
Those adapters follow the contract and convert the backend data to the domain entities</p><p>The rest of the flow is the same: the domain does not know how the data is retrieved, only knows how to use it. This gives us a lot of flexibility, we can change the backend without changing the domain the application, or the views.</p><h3 id=the-dependency-injection>The dependency injection</h3><p>The last piece of the &ldquo;puzzle&rdquo; is the dependency injection, which allows us, to replace a repository implementation with another one that follows the same port interface, but instead of importing it from the code that will call the repository, we inject it from outside allows us to change it easily.</p><p>Let&rsquo;s suppose we have a <code>usecase</code> (or application service) that will use the repository to get the menu:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GetMainMenuUseCase</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>menuRepo</span>: <span style=color:#66d9ef>MenuRepo</span>) {}
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>states</span>: <span style=color:#66d9ef>State</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>(<span style=color:#a6e22e>MenuItemDto</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>MenuDto</span>)[]<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>menuRepo</span>.<span style=color:#a6e22e>getMainMenu</span>(<span style=color:#a6e22e>states</span>).<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>entity</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>entity</span>.<span style=color:#a6e22e>toDto</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can use a factory to create the repository implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createMenuRepo</span>(<span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>MenuRepo</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ([<span style=color:#e6db74>&#39;client123&#39;</span>, <span style=color:#e6db74>&#39;client34&#39;</span>].<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>clientId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>V2MenuRepo</span>()
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LegacyMenuRepo</span>()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>useCase</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetMainMenuUseCase</span>(<span style=color:#a6e22e>createMenuRepo</span>(<span style=color:#e6db74>&#39;client123&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>usecase</span>.<span style=color:#a6e22e>execute</span>([<span style=color:#e6db74>&#39;open&#39;</span>, <span style=color:#e6db74>&#39;only-for-staff&#39;</span>]) 
</span></span></code></pre></div><h2 id=summarizing>Summarizing</h2><p>The hexagonal architecture, the repository pattern, and the dependency injection are very powerful tools that allow us to create decoupled software that works in independent pieces loosely coupled that can be easily changed and make the maintenance simpler.</p><p>Those pieces should define a contract for the actions (execute a method) and for the returned data, should not uses in other places, for example is a bad practice to pass the filters directly to the repository implementation and use them as is in the http request because you ara coupling your application code to the backend as we see in the example when we map the filter values</p><p>As you can see in the example, we can change the backend at any moment, it&rsquo;s just to change the repo implementation we inject into the use case without changing anything else.</p><p>This will work only if all the different backend returns the same business concepts, if not we are talking about different domain models and we need to create different ports and adapters for each one.</p><p>Achieve that can require time and knowledge of the domain and the business rules, but the benefits are worth it.</p></div></div><aside class=post__nav-wrapper><div class=wrapper-1200><div class="post-nav post-nav--prev"><a class=post-nav__link href="https://sergiocarracedo.es/a-real-world-on-a-meeting-light-sign/?ref=footer"><div class="post-nav__cover btn btn--img btn--hover-parent"><img alt=.Next.Title src=/a-real-world-on-a-meeting-light-sign/IMG_20240518_172824_hu6134575115211362306.jpg width=200 height=120></div><div class=post-nav__title>A real-world "on a meeting" light sign</div></a></div><div class=blog-link><a class="btn btn--outlined" href=https://sergiocarracedo.es/blog>All Blog posts</a></div><div class="post-nav post-nav--next"><a class=post-nav__link href="https://sergiocarracedo.es/ui-components-library-ii-anatomy-interfaces/?ref=footer"><div class="post-nav__cover btn btn--img btn--hover-parent"><img alt=.Prev.Title class=post-nav__cover src=/ui-components-library-ii-anatomy-interfaces/OIG2_2_hu4593881502760570847.jpeg width=200 height=120></div><div class=post-nav__title>UI components library (Chapter II): Components...</div></a></div></div><div class="wrapper-1200 post__nav-years"><ul class=years><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2024>2024</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2023>2023</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2022>2022</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2021>2021</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2020>2020</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2019>2019</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2018>2018</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2017>2017</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2016>2016</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2015>2015</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2013>2013</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2012>2012</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2011>2011</a></li><li><a class=link href=https://sergiocarracedo.es/blog/by-year#2010>2010</a></li></ul></div></aside><aside class=post__search-wrapper><div class=wrapper-1200>Search in <strong>147</strong> blog posts:<form action=https://sergiocarracedo.es/search class="search-form search-form--dark search-form--l" method=get><label for=search-input hidden>Search</label>
<input class=search-form__input id=search-input name=query placeholder=Search type=text>
<button aria-label="Search in the blog" class=search-form__button>
<i class="fas fa-search"></i></button></form></div></aside><aside class=post__comments><div class=wrapper-1200><div id=disqus_thread>To show comments is mandatory to accept cookie policy.</div></div></aside></article></div><footer class="web-footer background-paper-secondary"><div class=wrapper-1200><div class=web-footer__left><div class=me><div class=me__avatar><img alt="Sergio Carracedo" height=180 src=/i/sergiocarracedo_hu3613990337080381956.jpg width=180></div><div class=me__titles><h1>Sergio Carracedo</h1><h2>Senior Fullstack developer.</h2><h3>Always learning, cats, good conversations and small details lover.</h3></div></div></div><div class=web-footer__right><nav class=menu><ul role=menu><li class=menu__item role=presentation><a role=menuitem href=https://sergiocarracedo.es/>Home</a></li><li class=menu__item role=presentation><a role=menuitem href=https://sergiocarracedo.es/blog>Blog</a></li><li class=menu__item role=presentation><a role=menuitem href=https://sergiocarracedo.es/index.xml>RSS Feed</a></li></ul></nav><div class=social><a class=social__link href=http://www.linkedin.com/in/sergiocarracedo target=_blank title=LinkedIn style=animation-delay:2s><i class="fab fa-linkedin"></i>
</a><a class=social__link href=mailto:hi+blog@sergiocarracedo.es target=_blank title=Email style=animation-delay:1.9333333333333333s><i class="fas fa-envelope"></i>
</a><a class=social__link href=https://github.com/sergiocarracedo target=_blank title=GitHub style=animation-delay:1.8666666666666667s><i class="fab fa-github"></i>
</a><a class=social__link href=https://bsky.app/profile/sergiocarracedo.es target=_blank title=Bluesky style=animation-delay:1.8s><svg fill="none" viewBox="0 0 64 57"><path fill="currentcolor" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022.0 8.51.0 6.55.0-3.268 8.579-.182 13.873 3.805zm36.254.0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"/></svg>
</a><a class=social__link href=https://www.drupal.org/u/sergiocarracedo target=_blank title=Drupal style=animation-delay:1.7333333333333334s><i class="fab fa-drupal"></i>
</a><a class=social__link href=https://www.npmjs.com/~sergiocarracedo target=_blank title=Npm style=animation-delay:1.6666666666666667s><svg viewBox="0 0 780 250" aria-hidden="true"><path fill="currentcolor" d="M240 250h1e2v-50h1e2V0H240V250zM340 50h50v1e2h-50V50zM480 0v2e2h1e2V50h50v150h50V50h50v150h50V0H480zM0 2e2h1e2V50h50v150h50V0H0V2e2z" stroke-width="5" stroke="currentcolor"/></svg>
</a><a class=social__link href=https://www.twitter.com/sergiocarracedo target=_blank title=Twitter style=animation-delay:1.6s><i class="fab fa-twitter"></i>
</a><a class=social__link href=http://www.last.fm/user/gasman40 target=_blank title=Last.fm style=animation-delay:1.5333333333333332s><i class="fab fa-lastfm"></i>
</a><a class=social__link href=http://sergiocarracedo.tumblr.com/ target=_blank title=Tumblr style=animation-delay:1.4666666666666668s><i class="fab fa-tumblr"></i></a></div></div></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-87X78TXEGE"></script><script>function runGA(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-87X78TXEGE")}</script><script>function runDisqus(){(function(){var e=document,t=e.createElement("script");t.src="https://sergiocarracedo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()}</script><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#004262",text:"#fff"},button:{background:"#8ec760",text:"#ffffff"}},type:"opt-out",content:{message:"Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",allow:"Ok, continua",deny:"Nada de cookies",link:"Saber más",href:"https://sergiocarracedo.es/cookies"},onStatusChange:function(e){e=="allow"&&runCookiesAllowed()},onInitialise:function(e){e=="allow"&&runCookiesAllowed()}})})</script><script>addEventListener("scroll",e=>{let t=document.getElementsByTagName("body")[0];t&&window.scrollY>10?t.classList.add("not-in-top"):t.classList.remove("not-in-top")});function runCookiesAllowed(){runGA(),runDisqus()}</script><script integrity="sha256-hyPros3hoBf0jJM1+zayQLFFkchXwy4d/k2QMvk0sHs=" src=https://sergiocarracedo.es/js/theme.min.8723eba2cde1a017f48c9335fb36b240b14591c857c32e1dfe4d9032f934b07b.js></script><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js type=text/javascript></script><script integrity="sha256-9aiKKMxF0IhB2gmJbfgVOjk8GCtKW7zP2MwD74dPfDo=" src=https://sergiocarracedo.es/js/search.min.f5a88a28cc45d08841da09896df8153a393c182b4a5bbccfd8cc03ef874f7c3a.js></script></body></html>