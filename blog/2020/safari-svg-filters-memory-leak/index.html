<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible><meta content="width=device-width,minimum-scale=1" name=viewport><title>Sergio Carracedo | Webkit (Safari) memory leak using SVG filters</title>
<meta content="yes" name=apple-mobile-web-app-capable><meta content="black-translucent" name=apple-mobile-web-app-status-bar-style><meta content="Sergio Carracedo's personal page and blog" name=description><meta content="Sergio Carracedo" name=author><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="Webkit (Safari) memory leak using SVG filters"><meta property="og:description" content="The context
A few weeks ago I was developing a website using NuxtJs (which is not important for the problem but the is the context &#x1f609; ). That was a website that needs to use a few images as building blocks, the typical section separator with a shape different to a simple line, in this case, the section&rsquo;s separator had 2 colors and a shadow.
I decided to use SVG images for several reasons, for example the images had to adapt to different screen widths, and the images were simple (more complex than a line but simple, They were similar to 2 waves with 2 colors). The SVG files are very useful in these use case, because the file size is small, and you can scale them infinitely without lost definition.
One important thing in this issue as we&rsquo;ll see later is that this image had a shadow."><meta property="og:type" content="article"><meta property="og:url" content="https://sergiocarracedo.es/blog/2020/safari-svg-filters-memory-leak/"><meta property="og:image" content="https://sergiocarracedo.es/blog/2020/safari-svg-filters-memory-leak/cover_pixbay_1807581_hu17209517980204226989.jpg"><meta name=twitter:image content="https://sergiocarracedo.es/blog/2020/safari-svg-filters-memory-leak/cover_pixbay_1807581_hu17209517980204226989.jpg"></meta><meta property="article:section" content="blog">
<meta property="article:published_time" content="2020-11-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-02T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"></meta>
<link rel=canonical href=https://sergiocarracedo.es/blog/2020/safari-svg-filters-memory-leak/><link href=https://sergiocarracedo.es/scss/main.1559a03561830d7de305f4c9f989ccda247f022d321e21b0e121c745373917ff.css integrity="sha256-FVmgNWGDDX3jBfTJ+YnM2iR/Ai0yHiGw4SHHRTc5F/8=" rel=stylesheet><link href=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css rel=stylesheet type=text/css></head><body><header class="web-header background-paper-secondary"><h2><a class=back-to-home href=/ title="Back to home"><i class="fas fa-home"></i><div class=back-to-home__content><span class=back-to-home__action>Back to home</span><div class=back-to-home__title><img alt="Sergio Carracedo" class=avatar src=/i/sergiocarracedo_hu15161314200389136556.jpg><h4>Sergio Carracedo</h4></div></div></a></h2><div class=web-header__page-title><span>Webkit (Safari) memory leak using SVG filters</span></div><div class=theme-switch><i class="theme-switch__theme fas fa-sun" id=theme-switch-light title="Switch to light theme"></i>
<i class="theme-switch__theme fas fa-moon" id=theme-switch-dark title="Switch to dark theme"></i></div></header><div class=main-content><article class="post post--single"><div class="post__main wrapper-1200"><aside class=post__metadata><time class=post__date datetime=2020-11-02><i class="far fa-calendar-alt"></i> Nov 2, 2020
</time><a href=https://sergiocarracedo.es/tags/safari class=post__tag><span>safari</span>
</a><a href=https://sergiocarracedo.es/tags/bug class=post__tag><span>bug</span>
</a><a href=https://sergiocarracedo.es/tags/browserstack class=post__tag><span>browserstack</span>
</a><span class=post__reading-time><i class="far fa-clock"></i> 4 minutes read</span></aside><header class=post__header><h1 class=post__title>Webkit (Safari) memory leak using SVG filters</h1></header><figure class=post__cover><img src=/blog/2020/safari-svg-filters-memory-leak/cover_pixbay_1807581_hu13758865451085704278.jpg alt="Webkit (Safari) memory leak using SVG filters" width=1200 height=400></figure><div class=post__content><h2 id=the-context>The context</h2><p>A few weeks ago I was developing a website using <a href=https://nuxtjs.org/>NuxtJs</a> (which is not important for the problem but the is the context &#x1f609; ). That was a website that needs to use a few images as building blocks, the typical section separator with a shape different to a simple line, in this case, the section&rsquo;s separator had 2 colors and a shadow.</p><p>I decided to use SVG images for several reasons, for example the images had to adapt to different screen widths, and the images were simple (more complex than a line but simple, They were similar to 2 waves with 2 colors). The SVG files are very useful in these use case, because the file size is small, and you can scale them infinitely without lost definition.<br>One important thing in this issue as we&rsquo;ll see later is that this image had a shadow.</p><h2 id=the-problem>The problem</h2><p>Well, I was almost done templating the website, and we started to test the website in different browsers and platforms, and everything was fine, except because Safari users complain about the browser displays a notice:</p><blockquote><p>This webpage is using significant memory. Closing it may improve the responsiveness of your Mac.</p></blockquote><p>As side effect, the website animations were not fluid.</p><h2 id=reproducing-the-problem-and-fixing-it>Reproducing the problem and fixing it</h2><p>I needed to test the website by myself to find the reason of this issue. I don&rsquo;t own a Mac computer, but I have a <a href=https://www.browserstack.com/>BrowserStack</a> account.</p><p><a href=https://www.browserstack.com/>BrowserStack</a> is a SaaS that allows you to connect, using your browser, to remote devices with other browsers / OS. You can even select old browser versions, a mobile device (like iPhones, etc)</p><p><img src=/blog/2020/safari-svg-filters-memory-leak/browserstack.jpg></p><blockquote><p><strong>Off-Topic</strong>: BrowserStack supports my open source project <a href=https://sirenogrid.com/>SirenoGrid</a></p></blockquote><p>So, with my BrowserStack account, I could try to reproduce the problem. I open a Safari 13.1 (lastest version) instance in MacOS Catalina, and opened the website, and using the devtools got info about memory usage, and <strong>it was over 1.4 GB!!!!</strong>
And if you reloaded the website memory usage grows until the system got unresponsive.</p><p>The first thing I thought is that the problem was the animations. I remove them: <em>Nothing changes</em>.</p><p>I remove javascript: <em>Nothing</em> &#x1f615;</p><p>I continue removing things and trying other things to understand the problem. <em>No results</em> &#x1f62e;</p><p>After a long time, I was already a little desperate I disabled all website content blocks, and I realized that when it was a block with an SVG image in the screen, the memory usage was high.</p><p>I tried the same for a block with a png image and memory still normal.</p><p>WTF?? It should be SVG images.</p><p>Then, I replaced all SVG images with PNG versions and website works with reasonable memory usage &#x1f389;</p><h2 id=isolating-the-issue>Isolating the issue</h2><p>After fixing the problem and with more time I wanted to know because SVG files were causing this high memory usage.</p><p>I searched on Google information for issues in Safari and SVG and I didn&rsquo;t find anything that fit my issue, some diffuse references.</p><p>I created a sandbox to isolate the issue, I will not go into detail, but after some test and fail iterations I realized that the issue was related to SVG Filters.</p><p>With this information, I repeated the Google search, and I found information relative to Safari, SVG and filters issues <a href="https://bugs.webkit.org/show_bug.cgi?id=78814">1</a>, <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=583471">2</a> (Some of them are very old), and the most similar: <a href=https://github.com/mapbox/mapbox-gl-js/issues/7476>https://github.com/mapbox/mapbox-gl-js/issues/7476</a></p><h2 id=the-bug>The bug</h2><p>If you open in Safari a normal webpage, for example: <a href=https://apple.com>https://apple.com</a> which is a webpage with images, javascript, animations, video, etc. The Safari Timeline inspector says the memory usage is around 205MB</p><p><img src=/blog/2020/safari-svg-filters-memory-leak/apple_com.jpg></p><p>I prepared a bug demo codesandbox, just with 2 simple svg images:</p><blockquote><p><a href=https://5emtw.csb.app>https://5emtw.csb.app</a> &#x2757; Open with responsibility in Safari &#x2757;</p></blockquote><p>And in the first load that is the memory usage is around 600 MB!!!! &#x1f92f; That&rsquo;s crazy</p><p><img src=/blog/2020/safari-svg-filters-memory-leak/memory_leak.jpg></p><p>And if you reload the page a few times the situations will be worse</p><p><img src=images/2020/safari-svg/memory_leak_after_3_reloads.jpg></p><p>After 3 reloads the memory usage is 1.26 GB, absolutely crazy.</p><p>The same page, and the same images, but without filters</p><blockquote><p><a href=https://5emtw.csb.app/nofilters.html>https://5emtw.csb.app/nofilters.html</a></p></blockquote><p>The memory usage is only 21 MB, that it&rsquo;s a very normal memory usage</p><p><img src=/blog/2020/safari-svg-filters-memory-leak/without-filters.jpg></p><p>Even with a simple filter, like:</p><p><code>&lt;feFlood flood-opacity="1" result="BackgroundImageFix"/></code></p><p>The memory starts to go high, I&rsquo;m not sure what cause the problem, but in my opinion is something related to composition, I guess the browser keeps in memory the raw result of applying a filter and after making all the compositions layers .</p><p>I reported that bug in the Webkit Bugzilla page: <a href="https://bugs.webkit.org/show_bug.cgi?id=218422">https://bugs.webkit.org/show_bug.cgi?id=218422</a>
I hope they fix it soon.</p></div></div><aside class=post__nav-wrapper><div class=wrapper-1200><div class="post-nav post-nav--prev"><a class=post-nav__link href="https://sergiocarracedo.es/2020-in-a-nutshell/?ref=footer"><div class="post-nav__cover btn btn--img btn--hover-parent"><img alt=.Next.Title src=/2020-in-a-nutshell/pexels-cottonbro-3401900_hu3475308272719613870.jpg></div><div class=post-nav__title>2020 in a nutshell</div></a></div><div class=blog-link><a class="btn btn--outlined" href=https://sergiocarracedo.es/blog>All Blog posts</a></div><div class="post-nav post-nav--next"><a class=post-nav__link href="https://sergiocarracedo.es/blog/2020/creating-your-own-vue-ui-components-library-from-scratch-to-npm/?ref=footer"><div class="post-nav__cover btn btn--img btn--hover-parent"><img alt=.Prev.Title class=post-nav__cover src=/blog/2020/creating-your-own-vue-ui-components-library-from-scratch-to-npm/vue-components-talk_hu8908023812393904436.jpg></div><div class=post-nav__title>Talk: Creating your own Vue UI components library:...</div></a></div></div></aside><aside class=post__search-wrapper><div class=wrapper-1200>Search in this blog:<form class="search-form search-form--dark search-form--l" action=https://sergiocarracedo.es/search method=get><label hidden for=search-input>Search</label>
<input type=text id=search-input name=query placeholder=Search class=search-form__input>
<button class=search-form__button>
<i class="fas fa-search"></i></button></form></div></aside><aside class=post__comments><div class=wrapper-1200><div id=disqus_thread>To show the comments is mandatory accept cookie policy.</div></div></aside></article></div><footer class="web-footer background-paper-secondary"><div class=wrapper-1200><div class=web-footer__left><div class=me><div class=me__avatar><img alt="Sergio Carracedo" src=/i/sergiocarracedo_hu3613990337080381956.jpg></div><div class=me__titles><h1>Sergio Carracedo</h1><h2>Senior Fullstack developer.</h2><h3>Always learning, cats, good conversations and small details lover.</h3></div></div></div><div class=web-footer__right><nav role=main class=menu><ul><li class=menu__item><a href=https://sergiocarracedo.es/>Home</a></li><li class=menu__item><a href=https://sergiocarracedo.es/blog>Blog</a></li></ul></nav><div class=social><a class=social__link href=http://www.linkedin.com/in/sergiocarracedo target=_blank title=LinkedIn style=animation-delay:2s><i class="fab fa-linkedin"></i>
</a><a class=social__link href=mailto:hi+blog@sergiocarracedo.es target=_blank title=Email style=animation-delay:1.9333333333333333s><i class="fas fa-envelope"></i>
</a><a class=social__link href=https://github.com/sergiocarracedo target=_blank title=GitHub style=animation-delay:1.8666666666666667s><i class="fab fa-github"></i>
</a><a class=social__link href=https://www.drupal.org/u/sergiocarracedo target=_blank title=Drupal style=animation-delay:1.8s><i class="fab fa-drupal"></i>
</a><a class=social__link href=https://www.twitter.com/sergiocarracedo target=_blank title=Twitter style=animation-delay:1.7333333333333334s><i class="fab fa-twitter"></i>
</a><a class=social__link href=http://www.last.fm/user/gasman40 target=_blank title=Last.fm style=animation-delay:1.6666666666666667s><i class="fab fa-lastfm"></i>
</a><a class=social__link href=http://sergiocarracedo.tumblr.com/ target=_blank title=Tumblr style=animation-delay:1.6s><i class="fab fa-tumblr"></i></a></div></div></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-87X78TXEGE"></script><script>function runGA(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-87X78TXEGE")}</script><script>function runDisqus(){(function(){var e=document,t=e.createElement("script");t.src="https://sergiocarracedo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()}</script><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#004262",text:"#fff"},button:{background:"#8ec760",text:"#ffffff"}},type:"opt-out",content:{message:"Este sitio usa cookies propias y de terceros para mejorar la experiencia de usuario y esas cosas.",allow:"Ok, continua",deny:"Nada de cookies",link:"Saber más",href:"https://sergiocarracedo.es/cookies"},onStatusChange:function(e){e=="allow"&&runCookiesAllowed()},onInitialise:function(e){e=="allow"&&runCookiesAllowed()}})})</script><script>addEventListener("scroll",e=>{let t=document.getElementsByTagName("body")[0];t&&window.scrollY>10?t.classList.add("not-in-top"):t.classList.remove("not-in-top")});function runCookiesAllowed(){runGA(),runDisqus()}</script><script integrity="sha256-iiQa3rTjie3Ydsr4WEu2+aLDTaxKKVR3ZTwTYrRUjXs=" src=https://sergiocarracedo.es/js/theme.8a241adeb4e389edd876caf8584bb6f9a2c34dac4a295477653c1362b4548d7b.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script integrity="sha256-LVPRt2Ca+MpOY1KztdII4jRv+U0kJBcBZEvwhZr2a4Y=" src=https://sergiocarracedo.es/js/search.2d53d1b7609af8ca4e6352b3b5d208e2346ff94d24241701644bf0859af66b86.js></script></body></html>